<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>IrisScope â€” AI Iris Analysis</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet"/>
<style>
/* â”€â”€ DESIGN TOKENS â”€â”€ */
:root {
  --c-bg:       #060d14;
  --c-surface:  #0c1a27;
  --c-card:     #0f2233;
  --c-border:   rgba(0,200,160,0.15);
  --c-teal:     #00c8a0;
  --c-teal2:    #028090;
  --c-mint:     #02f5c4;
  --c-gold:     #f5a623;
  --c-red:      #ff4d6d;
  --c-blue:     #4dabf7;
  --c-text:     #e8f4f0;
  --c-muted:    #6b8f80;
  --c-white:    #ffffff;
  --r:          12px;
  --r-lg:       20px;
  --shadow:     0 8px 40px rgba(0,0,0,0.5);
  --glow:       0 0 30px rgba(0,200,160,0.2);
}
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }

body {
  font-family:'DM Sans',sans-serif;
  background:var(--c-bg);
  color:var(--c-text);
  min-height:100vh;
  overflow-x:hidden;
}

/* Animated mesh background */
body::before {
  content:'';
  position:fixed; inset:0; z-index:-1;
  background:
    radial-gradient(ellipse 60% 50% at 20% 20%, rgba(0,200,160,0.07) 0%, transparent 70%),
    radial-gradient(ellipse 50% 60% at 80% 80%, rgba(2,128,144,0.07) 0%, transparent 70%),
    radial-gradient(ellipse 40% 40% at 50% 50%, rgba(0,0,0,0) 0%, var(--c-bg) 100%);
  pointer-events:none;
}

/* â”€â”€ UTILITY â”€â”€ */
.hidden { display:none !important; }
.flex   { display:flex; }
.col    { flex-direction:column; }
.gap-1  { gap:8px; }
.gap-2  { gap:16px; }
.gap-3  { gap:24px; }
.center { align-items:center; justify-content:center; }
.w100   { width:100%; }

/* â”€â”€ SCROLL â”€â”€ */
::-webkit-scrollbar { width:5px; }
::-webkit-scrollbar-track { background:var(--c-surface); }
::-webkit-scrollbar-thumb { background:var(--c-teal2); border-radius:3px; }

/* â”€â”€ AUTH SCREEN â”€â”€ */
#auth-screen {
  position:fixed; inset:0; z-index:100;
  background:var(--c-bg);
  display:flex; align-items:center; justify-content:center;
  padding:20px;
}
.auth-box {
  background:var(--c-surface);
  border:1px solid var(--c-border);
  border-radius:var(--r-lg);
  padding:48px 40px;
  width:100%; max-width:420px;
  box-shadow:var(--shadow), var(--glow);
  text-align:center;
}
.auth-logo { font-size:3rem; margin-bottom:12px; }
.auth-box h1 {
  font-family:'Syne',sans-serif;
  font-size:2rem; font-weight:800;
  color:var(--c-teal); margin-bottom:4px;
}
.auth-box p { color:var(--c-muted); font-size:.9rem; margin-bottom:32px; }
.auth-tabs { display:flex; gap:4px; margin-bottom:28px;
  background:var(--c-card); border-radius:8px; padding:4px; }
.auth-tab {
  flex:1; padding:8px; border:none; background:none;
  color:var(--c-muted); font-family:'DM Sans',sans-serif; font-size:.9rem;
  border-radius:6px; cursor:pointer; transition:.2s;
}
.auth-tab.active { background:var(--c-teal); color:#000; font-weight:500; }
.field { margin-bottom:16px; text-align:left; }
.field label { display:block; font-size:.8rem; color:var(--c-muted); margin-bottom:6px; }
.field input {
  width:100%; padding:12px 16px;
  background:var(--c-card); border:1px solid var(--c-border);
  border-radius:var(--r); color:var(--c-text);
  font-family:'DM Sans',sans-serif; font-size:.95rem;
  outline:none; transition:.2s;
}
.field input:focus { border-color:var(--c-teal); box-shadow:0 0 0 3px rgba(0,200,160,0.1); }
.btn-primary {
  width:100%; padding:13px;
  background:linear-gradient(135deg,var(--c-teal),var(--c-teal2));
  border:none; border-radius:var(--r); color:#000;
  font-family:'Syne',sans-serif; font-size:1rem; font-weight:700;
  cursor:pointer; transition:.2s; letter-spacing:.5px;
}
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 4px 20px rgba(0,200,160,0.4); }
.auth-msg { font-size:.8rem; color:var(--c-red); margin-top:12px; min-height:20px; }

/* â”€â”€ APP SHELL â”€â”€ */
#app { display:flex; height:100vh; overflow:hidden; }

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar {
  width:240px; min-width:240px;
  background:var(--c-surface);
  border-right:1px solid var(--c-border);
  display:flex; flex-direction:column;
  padding:24px 0;
  transition:.3s;
}
.sidebar-logo {
  display:flex; align-items:center; gap:10px;
  padding:0 20px 24px;
  border-bottom:1px solid var(--c-border);
}
.sidebar-logo .eye-icon { font-size:1.8rem; }
.sidebar-logo h2 {
  font-family:'Syne',sans-serif;
  font-size:1.3rem; font-weight:800; color:var(--c-teal);
}
.sidebar-logo span { font-size:.7rem; color:var(--c-muted); display:block; }
nav { flex:1; padding:20px 12px; display:flex; flex-direction:column; gap:4px; }
.nav-item {
  display:flex; align-items:center; gap:10px;
  padding:11px 12px; border-radius:var(--r);
  cursor:pointer; transition:.2s; font-size:.9rem;
  color:var(--c-muted); border:none; background:none; width:100%; text-align:left;
}
.nav-item:hover { background:rgba(0,200,160,0.08); color:var(--c-text); }
.nav-item.active { background:rgba(0,200,160,0.15); color:var(--c-teal); font-weight:500; }
.nav-item .ni { width:20px; text-align:center; font-size:1.1rem; }
.sidebar-footer {
  padding:16px 12px;
  border-top:1px solid var(--c-border);
}
.user-card {
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:var(--r);
  background:var(--c-card);
}
.user-avatar {
  width:34px; height:34px; border-radius:50%;
  background:linear-gradient(135deg,var(--c-teal),var(--c-teal2));
  display:flex; align-items:center; justify-content:center;
  font-family:'Syne',sans-serif; font-weight:700; color:#000; font-size:.9rem;
}
.user-name { font-size:.85rem; font-weight:500; }
.user-email { font-size:.72rem; color:var(--c-muted); }
.logout-btn {
  background:none; border:none; color:var(--c-muted);
  cursor:pointer; font-size:.85rem; margin-top:8px;
  padding:8px 12px; border-radius:var(--r);
  width:100%; text-align:left; transition:.2s;
  display:flex; align-items:center; gap:8px;
}
.logout-btn:hover { color:var(--c-red); background:rgba(255,77,109,0.08); }

/* â”€â”€ MAIN CONTENT â”€â”€ */
#main { flex:1; overflow:auto; }
.page { display:none; padding:32px; max-width:1100px; margin:0 auto; }
.page.active { display:block; }

/* Top bar */
.topbar {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:32px;
}
.page-title { font-family:'Syne',sans-serif; font-size:1.7rem; font-weight:800; }
.page-title span { color:var(--c-teal); }
.lang-switcher {
  display:flex; gap:4px; background:var(--c-card);
  border-radius:8px; padding:4px; border:1px solid var(--c-border);
}
.lang-btn {
  padding:6px 12px; border:none; background:none;
  color:var(--c-muted); font-family:'DM Sans',sans-serif; font-size:.82rem;
  border-radius:6px; cursor:pointer; transition:.2s; font-weight:500;
}
.lang-btn.active { background:var(--c-teal); color:#000; }

/* Cards */
.card {
  background:var(--c-card);
  border:1px solid var(--c-border);
  border-radius:var(--r-lg); padding:24px;
  box-shadow:var(--shadow);
}
.card-title {
  font-family:'Syne',sans-serif; font-size:1rem; font-weight:700;
  color:var(--c-teal); margin-bottom:16px;
  display:flex; align-items:center; gap:8px;
}

/* Grid */
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; }

/* â”€â”€ UPLOAD ZONE â”€â”€ */
.upload-zone {
  border:2px dashed var(--c-border);
  border-radius:var(--r-lg); padding:40px;
  text-align:center; cursor:pointer; transition:.3s;
  position:relative; overflow:hidden;
}
.upload-zone:hover, .upload-zone.drag { border-color:var(--c-teal); background:rgba(0,200,160,0.04); }
.upload-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; }
.upload-icon { font-size:3rem; margin-bottom:12px; }
.upload-zone h3 { font-family:'Syne',sans-serif; font-size:1rem; margin-bottom:6px; }
.upload-zone p { color:var(--c-muted); font-size:.85rem; }

/* â”€â”€ CANVAS â”€â”€ */
.canvas-wrap {
  position:relative; border-radius:var(--r);
  overflow:hidden; background:#000;
  display:flex; align-items:center; justify-content:center;
  min-height:280px;
}
canvas { max-width:100%; display:block; }
.canvas-badge {
  position:absolute; top:10px; left:10px;
  background:rgba(0,0,0,0.7); backdrop-filter:blur(4px);
  border:1px solid var(--c-border); border-radius:20px;
  padding:4px 12px; font-size:.75rem; color:var(--c-teal);
}

/* â”€â”€ SYMPTOMS â”€â”€ */
.symptom-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.sym-item { }
.sym-label {
  display:flex; align-items:center; justify-content:space-between;
  font-size:.85rem; margin-bottom:6px; color:var(--c-text);
}
.sym-val { font-weight:700; color:var(--c-teal); }
.sym-slider {
  -webkit-appearance:none; width:100%; height:5px;
  background:var(--c-surface); border-radius:3px; outline:none;
}
.sym-slider::-webkit-slider-thumb {
  -webkit-appearance:none; width:16px; height:16px;
  background:var(--c-teal); border-radius:50%; cursor:pointer;
  box-shadow:0 0 8px rgba(0,200,160,0.5);
}
.voice-btn {
  display:flex; align-items:center; gap:6px;
  padding:8px 14px; background:rgba(0,200,160,0.1);
  border:1px solid var(--c-border); border-radius:var(--r);
  color:var(--c-teal); font-size:.85rem; cursor:pointer; transition:.2s;
  font-family:'DM Sans',sans-serif;
}
.voice-btn:hover { background:rgba(0,200,160,0.2); }
.voice-btn.listening { background:rgba(255,77,109,0.15); border-color:var(--c-red); color:var(--c-red); animation:pulse 1s infinite; }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:.6} }

/* â”€â”€ RESULTS â”€â”€ */
.disease-card {
  background:var(--c-surface); border:1px solid var(--c-border);
  border-radius:var(--r); padding:16px; margin-bottom:12px; transition:.2s;
}
.disease-card:hover { border-color:rgba(0,200,160,0.3); }
.disease-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.disease-name { font-family:'Syne',sans-serif; font-weight:700; font-size:.95rem; }
.disease-pct { font-weight:700; color:var(--c-teal); font-size:1.1rem; }
.conf-track { background:rgba(255,255,255,0.07); border-radius:4px; height:8px; overflow:hidden; }
.conf-fill { height:100%; border-radius:4px; background:linear-gradient(90deg,var(--c-teal2),var(--c-teal)); transition:width .8s ease; }
.disease-desc { font-size:.8rem; color:var(--c-muted); margin-top:8px; }
.sector-tags { display:flex; flex-wrap:wrap; gap:4px; margin-top:8px; }
.sector-tag {
  font-size:.72rem; padding:2px 9px; border-radius:12px;
  background:rgba(0,200,160,0.12); color:var(--c-teal); border:1px solid rgba(0,200,160,0.2);
}

/* â”€â”€ SECTOR TABLE â”€â”€ */
.sector-table { width:100%; border-collapse:collapse; font-size:.82rem; }
.sector-table th { color:var(--c-muted); font-weight:500; text-align:left; padding:8px 12px; border-bottom:1px solid var(--c-border); }
.sector-table td { padding:8px 12px; border-bottom:1px solid rgba(255,255,255,0.03); }
.sector-table tr:hover td { background:rgba(0,200,160,0.04); }
.anomaly-dot { display:inline-block; width:8px; height:8px; border-radius:50%; }

/* â”€â”€ RECOMMENDATION BOX â”€â”€ */
.reco-box {
  border-radius:var(--r); padding:16px 20px;
  display:flex; gap:14px; align-items:flex-start;
}
.reco-icon { font-size:1.5rem; }
.reco-title { font-family:'Syne',sans-serif; font-weight:700; font-size:.95rem; margin-bottom:4px; }
.reco-text  { font-size:.85rem; color:var(--c-muted); }

/* â”€â”€ CHATBOT â”€â”€ */
#page-chat { max-width:900px; }
.chat-container {
  display:flex; flex-direction:column; height:calc(100vh - 200px);
  background:var(--c-card); border:1px solid var(--c-border);
  border-radius:var(--r-lg); overflow:hidden;
}
.chat-header {
  padding:16px 20px; border-bottom:1px solid var(--c-border);
  display:flex; align-items:center; gap:12px;
}
.chat-avatar {
  width:38px; height:38px; border-radius:50%;
  background:linear-gradient(135deg,var(--c-teal),var(--c-teal2));
  display:flex; align-items:center; justify-content:center; font-size:1.2rem;
}
.chat-status { width:8px; height:8px; border-radius:50%; background:#22c55e; display:inline-block; margin-right:6px; }
.chat-messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:14px; }
.msg { display:flex; gap:10px; max-width:80%; }
.msg.user { align-self:flex-end; flex-direction:row-reverse; }
.msg-bubble {
  padding:12px 16px; border-radius:16px; font-size:.88rem; line-height:1.5;
}
.msg.bot  .msg-bubble { background:var(--c-surface); border:1px solid var(--c-border); border-bottom-left-radius:4px; }
.msg.user .msg-bubble { background:linear-gradient(135deg,var(--c-teal2),var(--c-teal)); color:#000; border-bottom-right-radius:4px; }
.msg-avatar { width:30px; height:30px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:.9rem; }
.msg.bot  .msg-avatar { background:var(--c-surface); border:1px solid var(--c-border); }
.msg.user .msg-avatar { background:rgba(0,200,160,0.2); }
.msg-time { font-size:.7rem; color:var(--c-muted); margin-top:4px; text-align:right; }
.chat-input-area {
  padding:16px 20px; border-top:1px solid var(--c-border);
  display:flex; flex-direction:column; gap:10px;
}
.chat-controls { display:flex; gap:8px; }
.chat-input {
  flex:1; background:var(--c-surface); border:1px solid var(--c-border);
  border-radius:var(--r); padding:12px 16px; color:var(--c-text);
  font-family:'DM Sans',sans-serif; font-size:.9rem; outline:none; resize:none;
  transition:.2s;
}
.chat-input:focus { border-color:var(--c-teal); }
.chat-send-btn {
  padding:12px 20px; background:var(--c-teal); border:none;
  border-radius:var(--r); color:#000; font-weight:700;
  cursor:pointer; font-family:'Syne',sans-serif; transition:.2s;
}
.chat-send-btn:hover { background:var(--c-mint); }
.typing-indicator { display:flex; gap:4px; align-items:center; padding:4px 0; }
.typing-dot { width:6px; height:6px; background:var(--c-muted); border-radius:50%; animation:typing .8s infinite; }
.typing-dot:nth-child(2) { animation-delay:.15s; }
.typing-dot:nth-child(3) { animation-delay:.3s; }
@keyframes typing { 0%,80%,100%{transform:scale(1)}40%{transform:scale(1.4)} }

/* â”€â”€ HOSPITAL LOCATOR â”€â”€ */
.hospital-search {
  display:flex; gap:10px; margin-bottom:20px;
}
.search-input {
  flex:1; background:var(--c-card); border:1px solid var(--c-border);
  border-radius:var(--r); padding:12px 16px; color:var(--c-text);
  font-family:'DM Sans',sans-serif; font-size:.9rem; outline:none;
}
.search-input:focus { border-color:var(--c-teal); }
.search-btn {
  padding:12px 20px; background:var(--c-teal); border:none;
  border-radius:var(--r); color:#000; font-weight:700;
  cursor:pointer; font-family:'Syne',sans-serif;
}
.hospital-list { display:flex; flex-direction:column; gap:12px; }
.hospital-card {
  background:var(--c-card); border:1px solid var(--c-border);
  border-radius:var(--r); padding:16px; display:flex; gap:16px;
  align-items:flex-start; transition:.2s;
}
.hospital-card:hover { border-color:rgba(0,200,160,0.3); transform:translateX(4px); }
.hosp-icon {
  width:44px; height:44px; border-radius:var(--r);
  background:rgba(0,200,160,0.1); border:1px solid var(--c-border);
  display:flex; align-items:center; justify-content:center; font-size:1.3rem; flex-shrink:0;
}
.hosp-name { font-family:'Syne',sans-serif; font-weight:700; margin-bottom:4px; }
.hosp-addr { font-size:.8rem; color:var(--c-muted); }
.hosp-dist { font-size:.8rem; color:var(--c-teal); font-weight:500; margin-top:6px; }
.hosp-rating { display:flex; gap:2px; font-size:.75rem; color:var(--c-gold); }

/* â”€â”€ HISTORY â”€â”€ */
.history-list { display:flex; flex-direction:column; gap:12px; }
.hist-card {
  background:var(--c-card); border:1px solid var(--c-border);
  border-radius:var(--r); padding:16px;
  display:flex; align-items:center; gap:16px; transition:.2s; cursor:pointer;
}
.hist-card:hover { border-color:rgba(0,200,160,0.3); }
.hist-eye { width:48px; height:48px; border-radius:8px; object-fit:cover; background:var(--c-surface); overflow:hidden; flex-shrink:0; }
.hist-eye canvas { width:48px; height:48px; }
.hist-date { font-size:.75rem; color:var(--c-muted); }
.hist-result { font-weight:600; font-size:.9rem; }
.hist-conf { font-size:.8rem; color:var(--c-teal); }
.hist-actions { margin-left:auto; display:flex; gap:8px; }
.icon-btn {
  width:34px; height:34px; border-radius:8px;
  background:rgba(255,255,255,0.05); border:1px solid var(--c-border);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:.2s; font-size:.9rem;
}
.icon-btn:hover { background:rgba(0,200,160,0.1); border-color:var(--c-teal); }

/* â”€â”€ STATS â”€â”€ */
.stat-card {
  background:var(--c-card); border:1px solid var(--c-border);
  border-radius:var(--r); padding:20px;
}
.stat-val { font-family:'Syne',sans-serif; font-size:2rem; font-weight:800; color:var(--c-teal); }
.stat-label { font-size:.8rem; color:var(--c-muted); margin-top:4px; }
.stat-trend { font-size:.75rem; margin-top:8px; }

/* â”€â”€ DUAL EYE â”€â”€ */
.dual-compare { display:grid; grid-template-columns:1fr 1fr; gap:20px; }

/* â”€â”€ REPORT MODAL â”€â”€ */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.8);
  display:flex; align-items:center; justify-content:center;
  z-index:50; padding:20px; backdrop-filter:blur(4px);
}
.modal {
  background:var(--c-card); border:1px solid var(--c-border);
  border-radius:var(--r-lg); width:100%; max-width:680px;
  max-height:90vh; overflow-y:auto; box-shadow:var(--shadow);
}
.modal-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:20px 24px; border-bottom:1px solid var(--c-border);
  position:sticky; top:0; background:var(--c-card); z-index:1;
}
.modal-header h3 { font-family:'Syne',sans-serif; font-size:1.1rem; font-weight:700; }
.close-btn { background:none; border:none; color:var(--c-muted); font-size:1.4rem; cursor:pointer; }
.modal-body { padding:24px; }
.report-section { margin-bottom:24px; }
.report-section h4 {
  font-family:'Syne',sans-serif; font-size:.85rem; font-weight:700;
  color:var(--c-teal); text-transform:uppercase; letter-spacing:1px;
  margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--c-border);
}
.report-row { display:flex; justify-content:space-between; padding:6px 0; font-size:.88rem; }
.report-row span:first-child { color:var(--c-muted); }
.report-row span:last-child { font-weight:500; }
.modal-footer { padding:16px 24px; border-top:1px solid var(--c-border); display:flex; gap:10px; justify-content:flex-end; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position:fixed; bottom:24px; right:24px; z-index:200;
  background:var(--c-card); border:1px solid var(--c-border);
  border-radius:var(--r); padding:12px 18px;
  display:flex; align-items:center; gap:10px;
  box-shadow:var(--shadow); transform:translateY(100px); opacity:0;
  transition:.3s; font-size:.88rem;
}
.toast.show { transform:translateY(0); opacity:1; }
.toast-icon { font-size:1.1rem; }

/* â”€â”€ VOICE WAVE â”€â”€ */
.voice-wave { display:flex; align-items:center; gap:3px; height:20px; }
.wave-bar { width:3px; background:var(--c-teal); border-radius:2px; animation:wave 1s infinite; }
.wave-bar:nth-child(2){ animation-delay:.1s; height:10px; }
.wave-bar:nth-child(3){ animation-delay:.2s; height:18px; }
.wave-bar:nth-child(4){ animation-delay:.3s; height:12px; }
.wave-bar:nth-child(5){ animation-delay:.4s; height:8px; }
@keyframes wave { 0%,100%{transform:scaleY(.4)}50%{transform:scaleY(1)} }

/* â”€â”€ ANALYSE BTN â”€â”€ */
.analyse-btn {
  width:100%; padding:16px;
  background:linear-gradient(135deg,var(--c-teal2),var(--c-teal));
  border:none; border-radius:var(--r); color:#000;
  font-family:'Syne',sans-serif; font-size:1rem; font-weight:800;
  cursor:pointer; transition:.2s; letter-spacing:.5px; margin-top:8px;
  display:flex; align-items:center; justify-content:center; gap:10px;
}
.analyse-btn:hover { transform:translateY(-1px); box-shadow:0 6px 24px rgba(0,200,160,0.35); }
.analyse-btn:disabled { opacity:.5; cursor:not-allowed; transform:none; }

/* â”€â”€ LOADER â”€â”€ */
.loader {
  display:flex; align-items:center; justify-content:center;
  gap:10px; padding:30px; color:var(--c-muted); font-size:.9rem;
}
.spin {
  width:24px; height:24px; border:2px solid var(--c-border);
  border-top-color:var(--c-teal); border-radius:50%; animation:spin .8s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:768px) {
  #sidebar { display:none; }
  .grid-2, .grid-3, .dual-compare { grid-template-columns:1fr; }
  .symptom-grid { grid-template-columns:1fr; }
  .page { padding:16px; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-logo">ğŸ‘ï¸</div>
    <h1>IrisScope</h1>
    <p id="auth-sub">AI-powered iris analysis for early eye health awareness</p>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuth('login')" id="tab-login" data-en="Login" data-ta="à®‰à®³à¯à®¨à¯à®´à¯ˆ" data-hi="à¤²à¥‰à¤—à¤¿à¤¨">Login</button>
      <button class="auth-tab" onclick="switchAuth('register')" id="tab-reg" data-en="Register" data-ta="à®ªà®¤à®¿à®µà¯" data-hi="à¤°à¤œà¤¿à¤¸à¥à¤Ÿà¤°">Register</button>
    </div>

    <div id="login-form">
      <div class="field">
        <label id="lbl-email" data-en="Email" data-ta="à®®à®¿à®©à¯à®©à®à¯à®šà®²à¯" data-hi="à¤ˆà¤®à¥‡à¤²">Email</label>
        <input type="email" id="login-email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <label id="lbl-pass" data-en="Password" data-ta="à®•à®Ÿà®µà¯à®šà¯à®šà¯Šà®²à¯" data-hi="à¤ªà¤¾à¤¸à¤µà¤°à¥à¤¡">Password</label>
        <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
      </div>
      <button class="btn-primary" onclick="doLogin()" id="btn-login" data-en="Sign In" data-ta="à®‰à®³à¯à®¨à¯à®´à¯ˆ" data-hi="à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨">Sign In</button>
      <div class="auth-msg" id="auth-error"></div>
    </div>

    <div id="register-form" class="hidden">
      <div class="field">
        <label data-en="Full Name" data-ta="à®®à¯à®´à¯ à®ªà¯†à®¯à®°à¯" data-hi="à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®">Full Name</label>
        <input type="text" id="reg-name" placeholder="Your name"/>
      </div>
      <div class="field">
        <label>Email</label>
        <input type="email" id="reg-email" placeholder="you@example.com"/>
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="reg-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
      </div>
      <button class="btn-primary" onclick="doRegister()" id="btn-reg-submit" data-en="Create Account" data-ta="à®•à®£à®•à¯à®•à¯ˆ à®‰à®°à¯à®µà®¾à®•à¯à®•à¯" data-hi="à¤…à¤•à¤¾à¤‰à¤‚à¤Ÿ à¤¬à¤¨à¤¾à¤à¤‚">Create Account</button>
      <div class="auth-msg" id="auth-error2"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" class="hidden">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-logo">
      <span class="eye-icon">ğŸ‘ï¸</span>
      <div>
        <h2>IrisScope</h2>
        <span>AI Eye Analysis</span>
      </div>
    </div>
    <nav>
      <button class="nav-item active" onclick="showPage('analyze')" data-en="Analyse" data-ta="à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯" data-hi="à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£"><span class="ni">ğŸ”¬</span> Analyse</button>
      <button class="nav-item" onclick="showPage('dual')" data-en="Dual Eye Compare" data-ta="à®‡à®°à¯ à®•à®£à¯ à®’à®ªà¯à®ªà¯€à®Ÿà¯" data-hi="à¤¦à¥‹à¤¨à¥‹à¤‚ à¤†à¤à¤–à¥‡à¤‚"><span class="ni">ğŸ‘€</span> Dual Eye Compare</button>
      <button class="nav-item" onclick="showPage('chat')" data-en="AI Assistant" data-ta="AI à®‰à®¤à®µà®¿à®¯à®¾à®³à®°à¯" data-hi="AI à¤¸à¤¹à¤¾à¤¯à¤•"><span class="ni">ğŸ’¬</span> AI Assistant</button>
      <button class="nav-item" onclick="showPage('hospitals')" data-en="Find Hospitals" data-ta="à®®à®°à¯à®¤à¯à®¤à¯à®µà®®à®©à¯ˆ" data-hi="à¤…à¤¸à¥à¤ªà¤¤à¤¾à¤² à¤–à¥‹à¤œà¥‡à¤‚"><span class="ni">ğŸ¥</span> Find Hospitals</button>
      <button class="nav-item" onclick="showPage('history')" data-en="History" data-ta="à®µà®°à®²à®¾à®±à¯" data-hi="à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸"><span class="ni">ğŸ“‹</span> History</button>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="sidebar-avatar">U</div>
        <div>
          <div class="user-name" id="sidebar-name">User</div>
          <div class="user-email" id="sidebar-email">user@email.com</div>
        </div>
      </div>
      <button class="logout-btn" onclick="doLogout()">â‡¢ <span data-en="Logout" data-ta="à®µà¯†à®³à®¿à®¯à¯‡à®±à¯" data-hi="à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ">Logout</span></button>
    </div>
  </aside>

  <!-- MAIN -->
  <main id="main">

    <!-- â”€â”€ PAGE: ANALYSE â”€â”€ -->
    <div id="page-analyze" class="page active">
      <div class="topbar">
        <h1 class="page-title"><span>Iris</span> Analysis</h1>
        <div class="lang-switcher">
          <button class="lang-btn active" onclick="setLang('en')">EN</button>
          <button class="lang-btn" onclick="setLang('ta')">à®¤à®®à®¿à®´à¯</button>
          <button class="lang-btn" onclick="setLang('hi')">à¤¹à¤¿à¤‚à¤¦à¥€</button>
        </div>
      </div>

      <div class="grid-2" style="margin-bottom:20px">
        <!-- Upload -->
        <div class="card">
          <div class="card-title">ğŸ“· <span data-en="Upload Eye Image" data-ta="à®•à®£à¯ à®ªà®Ÿà®¤à¯à®¤à¯ˆ à®ªà®¤à®¿à®µà¯‡à®±à¯à®±à¯" data-hi="à¤†à¤‚à¤– à¤•à¥€ à¤¤à¤¸à¥à¤µà¥€à¤° à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚">Upload Eye Image</span></div>
          <div class="upload-zone" id="drop-zone" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event)">
            <input type="file" accept="image/*" onchange="loadImage(event,'left')"/>
            <div class="upload-icon">ğŸ“</div>
            <h3 data-en="Drop or click to upload" data-ta="à®•à¯‹à®ªà¯à®ªà¯ˆ à®‡à®™à¯à®•à¯‡ à®µà¯ˆà®¯à¯à®™à¯à®•à®³à¯" data-hi="à¤¯à¤¹à¤¾à¤ à¤›à¥‹à¤¡à¤¼à¥‡à¤‚ à¤¯à¤¾ à¤•à¥à¤²à¤¿à¤• à¤•à¤°à¥‡à¤‚">Drop or click to upload</h3>
            <p data-en="Supports JPG, PNG â€” clear front-facing eye photo" data-ta="JPG, PNG â€” à®¤à¯†à®³à®¿à®µà®¾à®© à®•à®£à¯ à®ªà®Ÿà®®à¯" data-hi="JPG, PNG â€” à¤¸à¥à¤ªà¤·à¥à¤Ÿ à¤†à¤à¤– à¤•à¥€ à¤«à¥‹à¤Ÿà¥‹">Supports JPG, PNG â€” clear front-facing eye photo</p>
          </div>
          <div style="height:12px"></div>
          <div class="canvas-wrap" id="orig-wrap">
            <canvas id="orig-canvas" width="360" height="280"></canvas>
            <div class="canvas-badge" id="orig-badge" style="display:none">ğŸ“· Original</div>
          </div>
        </div>

        <!-- Segmentation Preview -->
        <div class="card">
          <div class="card-title">ğŸ”¬ <span data-en="Segmentation Preview" data-ta="à®ªà®¿à®°à®¿à®µà¯ à®®à¯à®©à¯à®©à¯‹à®Ÿà¯à®Ÿà®®à¯" data-hi="à¤µà¤¿à¤­à¤¾à¤œà¤¨ à¤ªà¥‚à¤°à¥à¤µà¤¾à¤µà¤²à¥‹à¤•à¤¨">Segmentation Preview</span></div>
          <div class="canvas-wrap" style="margin-bottom:12px">
            <canvas id="seg-canvas" width="360" height="280"></canvas>
            <div class="canvas-badge">ğŸŸ¢ <span id="seg-status" data-en="Awaiting image..." data-ta="à®ªà®Ÿà®¤à¯à®¤à®¿à®±à¯à®•à®¾à®• à®•à®¾à®¤à¯à®¤à®¿à®°à¯à®•à¯à®•à®¿à®±à®¤à¯..." data-hi="à¤›à¤µà¤¿ à¤•à¥€ à¤ªà¥à¤°à¤¤à¥€à¤•à¥à¤·à¤¾...">Awaiting image...</span></div>
          </div>
          <div class="canvas-wrap">
            <canvas id="heatmap-canvas" width="360" height="280"></canvas>
            <div class="canvas-badge">ğŸŒ¡ï¸ <span data-en="Anomaly Heatmap" data-ta="à®…à®šà®¾à®¤à®¾à®°à®£ à®µà¯†à®ªà¯à®ª à®µà®°à¯ˆà®ªà®Ÿà®®à¯" data-hi="à¤µà¤¿à¤¸à¤‚à¤—à¤¤à¤¿ à¤¹à¥€à¤Ÿà¤®à¥ˆà¤ª">Anomaly Heatmap</span></div>
          </div>
        </div>
      </div>

      <!-- Symptoms -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-title" style="justify-content:space-between">
          <span>ğŸ“‹ <span data-en="Patient Symptoms" data-ta="à®¨à¯‹à®¯à®¾à®³à®¿ à®…à®±à®¿à®•à¯à®±à®¿à®•à®³à¯" data-hi="à¤®à¤°à¥€à¤œ à¤•à¥‡ à¤²à¤•à¥à¤·à¤£">Patient Symptoms</span> <small style="color:var(--c-muted);font-weight:400;font-size:.8rem" data-en="(0 = None, 3 = Severe)" data-ta="(0 = à®‡à®²à¯à®²à¯ˆ, 3 = à®•à®Ÿà¯à®®à¯ˆà®¯à®¾à®©)" data-hi="(0 = à¤•à¥‹à¤ˆ à¤¨à¤¹à¥€à¤‚, 3 = à¤—à¤‚à¤­à¥€à¤°)">(0 = None, 3 = Severe)</small></span>
          <button class="voice-btn" id="voice-sym-btn" onclick="toggleVoiceInput()">
            ğŸ¤ <span data-en="Voice Input" data-ta="à®•à¯à®°à®²à¯ à®‰à®³à¯à®³à¯€à®Ÿà¯" data-hi="à¤†à¤µà¤¾à¤œà¤¼ à¤‡à¤¨à¤ªà¥à¤Ÿ">Voice Input</span>
          </button>
        </div>
        <div id="voice-status" class="hidden" style="margin-bottom:12px;display:flex;align-items:center;gap:8px;font-size:.85rem;color:var(--c-teal)">
          <div class="voice-wave"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
          <span id="voice-text" data-en="Listening... speak your symptoms" data-ta="à®•à¯‡à®Ÿà¯à®•à®¿à®±à¯‡à®©à¯... à®‰à®™à¯à®•à®³à¯ à®…à®±à®¿à®•à¯à®±à®¿à®•à®³à¯ˆà®ªà¯ à®ªà¯‡à®šà¯à®™à¯à®•à®³à¯" data-hi="à¤¸à¥à¤¨ à¤°à¤¹à¤¾ à¤¹à¥‚à¤... à¤…à¤ªà¤¨à¥‡ à¤²à¤•à¥à¤·à¤£ à¤¬à¥‹à¤²à¥‡à¤‚">Listening... speak your symptoms</span>
        </div>
        <div class="symptom-grid">
          <div class="sym-item">
            <div class="sym-label"><span data-en="ğŸ”´ Eye Pain" data-ta="ğŸ”´ à®•à®£à¯ à®µà®²à®¿" data-hi="ğŸ”´ à¤†à¤à¤– à¤¦à¤°à¥à¤¦">ğŸ”´ Eye Pain</span><span class="sym-val" id="v-pain">0</span></div>
            <input type="range" class="sym-slider" min="0" max="3" value="0" oninput="updateSym('pain',this.value)" id="s-pain"/>
          </div>
          <div class="sym-item">
            <div class="sym-label"><span data-en="ğŸ”µ Blurred Vision" data-ta="ğŸ”µ à®®à®™à¯à®•à®²à®¾à®© à®ªà®¾à®°à¯à®µà¯ˆ" data-hi="ğŸ”µ à¤§à¥à¤‚à¤§à¤²à¥€ à¤¦à¥ƒà¤·à¥à¤Ÿà¤¿">ğŸ”µ Blurred Vision</span><span class="sym-val" id="v-blur">0</span></div>
            <input type="range" class="sym-slider" min="0" max="3" value="0" oninput="updateSym('blur',this.value)" id="s-blur"/>
          </div>
          <div class="sym-item">
            <div class="sym-label"><span data-en="ğŸŸ  Redness" data-ta="ğŸŸ  à®šà®¿à®µà®ªà¯à®ªà¯" data-hi="ğŸŸ  à¤²à¤¾à¤²à¤¿à¤®à¤¾">ğŸŸ  Redness</span><span class="sym-val" id="v-red">0</span></div>
            <input type="range" class="sym-slider" min="0" max="3" value="0" oninput="updateSym('red',this.value)" id="s-red"/>
          </div>
          <div class="sym-item">
            <div class="sym-label"><span data-en="ğŸŸ¡ Light Sensitivity" data-ta="ğŸŸ¡ à®’à®³à®¿ à®‰à®£à®°à¯à®¤à®¿à®±à®©à¯" data-hi="ğŸŸ¡ à¤ªà¥à¤°à¤•à¤¾à¤¶ à¤¸à¤‚à¤µà¥‡à¤¦à¤¨à¤¶à¥€à¤²à¤¤à¤¾">ğŸŸ¡ Light Sensitivity</span><span class="sym-val" id="v-light">0</span></div>
            <input type="range" class="sym-slider" min="0" max="3" value="0" oninput="updateSym('light',this.value)" id="s-light"/>
          </div>
          <div class="sym-item">
            <div class="sym-label"><span data-en="âšª Discharge" data-ta="âšª à®šà®³à®¿" data-hi="âšª à¤¸à¥à¤°à¤¾à¤µ">âšª Discharge</span><span class="sym-val" id="v-dis">0</span></div>
            <input type="range" class="sym-slider" min="0" max="3" value="0" oninput="updateSym('dis',this.value)" id="s-dis"/>
          </div>
          <div class="sym-item">
            <div class="sym-label"><span data-en="ğŸŸ£ Floaters" data-ta="ğŸŸ£ à®®à®¿à®¤à®µà¯ˆà®•à®³à¯" data-hi="ğŸŸ£ à¤«à¥à¤²à¥‹à¤Ÿà¤°à¥à¤¸">ğŸŸ£ Floaters</span><span class="sym-val" id="v-float">0</span></div>
            <input type="range" class="sym-slider" min="0" max="3" value="0" oninput="updateSym('float',this.value)" id="s-float"/>
          </div>
        </div>
        <div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:140px">
            <div class="sym-label" style="margin-bottom:6px"><span data-en="Age" data-ta="à®µà®¯à®¤à¯" data-hi="à¤†à¤¯à¥">Age</span></div>
            <input type="number" id="pt-age" value="35" min="1" max="120" style="width:100%;padding:8px 12px;background:var(--c-surface);border:1px solid var(--c-border);border-radius:8px;color:var(--c-text);font-family:'DM Sans',sans-serif;font-size:.9rem;outline:none"/>
          </div>
          <div style="flex:2;min-width:180px">
            <div class="sym-label" style="margin-bottom:6px" data-en="Symptom Duration" data-ta="à®…à®±à®¿à®•à¯à®±à®¿ à®•à®¾à®²à®®à¯" data-hi="à¤²à¤•à¥à¤·à¤£ à¤…à¤µà¤§à¤¿">Symptom Duration</div>
            <select id="pt-dur" style="width:100%;padding:9px 12px;background:var(--c-surface);border:1px solid var(--c-border);border-radius:8px;color:var(--c-text);font-family:'DM Sans',sans-serif;font-size:.9rem;outline:none">
              <option>< 1 day</option><option>1â€“3 days</option>
              <option>4â€“7 days</option><option>1â€“4 weeks</option><option>> 1 month</option>
            </select>
          </div>
        </div>
        <button class="analyse-btn" id="analyse-btn" onclick="runAnalysis()" disabled>
          ğŸ”¬ <span data-en="Analyse Iris" data-ta="à®•à®£à¯à®£à¯ˆ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯ à®šà¯†à®¯à¯" data-hi="à¤†à¤à¤– à¤•à¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¤°à¥‡à¤‚">Analyse Iris</span>
        </button>
      </div>

      <!-- Results -->
      <div id="results-section" class="hidden">
        <div class="grid-2" style="margin-bottom:20px">
          <!-- Predictions -->
          <div class="card">
            <div class="card-title">ğŸ§  <span data-en="AI Predictions" data-ta="AI à®•à®£à®¿à®ªà¯à®ªà¯à®•à®³à¯" data-hi="AI à¤­à¤µà¤¿à¤·à¥à¤¯à¤µà¤¾à¤£à¤¿à¤¯à¤¾à¤">AI Predictions</span></div>
            <div id="predictions-list"></div>
          </div>
          <!-- Sector table -->
          <div class="card">
            <div class="card-title">ğŸ“Š <span data-en="Sector Analysis" data-ta="à®¤à¯à®±à¯ˆ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯" data-hi="à¤¸à¥‡à¤•à¥à¤Ÿà¤° à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£">Sector Analysis</span></div>
            <table class="sector-table" id="sector-table">
              <thead><tr>
                <th data-en="Sector" data-ta="à®¤à¯à®±à¯ˆ" data-hi="à¤¸à¥‡à¤•à¥à¤Ÿà¤°">Sector</th>
                <th data-en="Hue" data-ta="à®µà®£à¯à®£à®®à¯" data-hi="à¤°à¤‚à¤—">Hue</th>
                <th data-en="Sat" data-ta="à®¨à®¿à®±à¯ˆà®µà¯" data-hi="à¤¸à¤‚à¤¤à¥ƒà¤ªà¥à¤¤à¤¿">Sat</th>
                <th data-en="Brightness" data-ta="à®ªà®¿à®°à®•à®¾à®šà®®à¯" data-hi="à¤šà¤®à¤•">Bri</th>
                <th data-en="Deviation" data-ta="à®µà®¿à®²à®•à®²à¯" data-hi="à¤µà¤¿à¤šà¤²à¤¨">Dev</th>
                <th data-en="Anomaly" data-ta="à®…à®šà®¾à®¤à®¾à®°à®£à®®à¯" data-hi="à¤µà¤¿à¤¸à¤‚à¤—à¤¤à¤¿">Anomaly</th>
              </tr></thead>
              <tbody id="sector-tbody"></tbody>
            </table>
          </div>
        </div>
        <!-- Recommendation -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-title">ğŸ’¡ <span data-en="Recommendation" data-ta="à®ªà®°à®¿à®¨à¯à®¤à¯à®°à¯ˆ" data-hi="à¤¸à¤¿à¤«à¤¼à¤¾à¤°à¤¿à¤¶">Recommendation</span></div>
          <div id="reco-box"></div>
          <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
            <button class="voice-btn" onclick="readResults()">ğŸ”Š <span data-en="Read Results" data-ta="à®®à¯à®Ÿà®¿à®µà¯à®•à®³à¯ˆ à®ªà®Ÿà®¿" data-hi="à¤ªà¤°à¤¿à¤£à¤¾à¤® à¤ªà¤¢à¤¼à¥‡à¤‚">Read Results</span></button>
            <button class="voice-btn" onclick="showReport()">ğŸ“„ <span data-en="Generate Report" data-ta="à®…à®±à®¿à®•à¯à®•à¯ˆ à®‰à®°à¯à®µà®¾à®•à¯à®•à¯" data-hi="à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ à¤¬à¤¨à¤¾à¤à¤‚">Generate Report</span></button>
            <button class="voice-btn" onclick="showPage('chat')">ğŸ’¬ <span data-en="Ask AI Assistant" data-ta="AI à®‰à®¤à®µà®¿à®¯à®¾à®³à®°à®¿à®Ÿà®®à¯ à®•à¯‡à®³à¯" data-hi="AI à¤¸à¥‡ à¤ªà¥‚à¤›à¥‡à¤‚">Ask AI Assistant</span></button>
          </div>
        </div>
      </div>
    </div><!-- /page-analyze -->

    <!-- â”€â”€ PAGE: DUAL EYE â”€â”€ -->
    <div id="page-dual" class="page">
      <div class="topbar">
        <h1 class="page-title">ğŸ‘€ <span>Dual Eye</span> Compare</h1>
      </div>
      <div class="dual-compare">
        <div class="card">
          <div class="card-title">ğŸ‘ï¸ Left Eye</div>
          <div class="upload-zone" style="margin-bottom:12px;padding:20px">
            <input type="file" accept="image/*" onchange="loadDualImage(event,'left')"/>
            <div style="font-size:1.5rem;margin-bottom:6px">ğŸ“</div>
            <p style="font-size:.82rem;color:var(--c-muted)">Upload left eye image</p>
          </div>
          <div class="canvas-wrap"><canvas id="dual-left" width="300" height="260"></canvas></div>
          <div id="dual-left-result" style="margin-top:12px;font-size:.82rem;color:var(--c-muted);text-align:center">Awaiting image...</div>
        </div>
        <div class="card">
          <div class="card-title">ğŸ‘ï¸ Right Eye</div>
          <div class="upload-zone" style="margin-bottom:12px;padding:20px">
            <input type="file" accept="image/*" onchange="loadDualImage(event,'right')"/>
            <div style="font-size:1.5rem;margin-bottom:6px">ğŸ“</div>
            <p style="font-size:.82rem;color:var(--c-muted)">Upload right eye image</p>
          </div>
          <div class="canvas-wrap"><canvas id="dual-right" width="300" height="260"></canvas></div>
          <div id="dual-right-result" style="margin-top:12px;font-size:.82rem;color:var(--c-muted);text-align:center">Awaiting image...</div>
        </div>
      </div>
      <div style="margin-top:16px">
        <button class="analyse-btn" id="dual-analyse-btn" style="max-width:360px;margin:0 auto" onclick="runDualAnalysis()">
          ğŸ”¬ Compare Both Eyes
        </button>
      </div>
      <div id="dual-comparison" class="hidden" style="margin-top:20px">
        <div class="card">
          <div class="card-title">ğŸ“Š Asymmetry Report</div>
          <div id="asymmetry-content"></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ PAGE: CHAT â”€â”€ -->
    <div id="page-chat" class="page">
      <div class="topbar">
        <h1 class="page-title">ğŸ’¬ <span>AI</span> Assistant</h1>
        <div class="lang-switcher">
          <button class="lang-btn active" onclick="setLang('en')">EN</button>
          <button class="lang-btn" onclick="setLang('ta')">à®¤à®®à®¿à®´à¯</button>
          <button class="lang-btn" onclick="setLang('hi')">à¤¹à¤¿à¤‚à¤¦à¥€</button>
        </div>
      </div>
      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-avatar">ğŸ¤–</div>
          <div>
            <div style="font-family:'Syne',sans-serif;font-weight:700">IrisScope Assistant</div>
            <div style="font-size:.78rem;color:var(--c-muted)">
              <span class="chat-status"></span>
              <span data-en="Online â€” here to help you understand your results" data-ta="à®†à®©à¯à®²à¯ˆà®©à®¿à®²à¯ à®‰à®³à¯à®³à¯‡à®©à¯ â€” à®‰à®™à¯à®•à®³à¯ à®®à¯à®Ÿà®¿à®µà¯à®•à®³à¯ˆ à®ªà¯à®°à®¿à®¨à¯à®¤à¯à®•à¯Šà®³à¯à®³ à®‰à®¤à®µà¯à®•à®¿à®±à¯‡à®©à¯" data-hi="à¤‘à¤¨à¤²à¤¾à¤‡à¤¨ â€” à¤†à¤ªà¤•à¥‡ à¤ªà¤°à¤¿à¤£à¤¾à¤® à¤¸à¤®à¤à¤¨à¥‡ à¤®à¥‡à¤‚ à¤®à¤¦à¤¦ à¤•à¥‡ à¤²à¤¿à¤">Online â€” here to help you understand your results</span>
            </div>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="voice-btn" id="chat-voice-btn" onclick="toggleChatVoice()">ğŸ¤</button>
            <button class="voice-btn" onclick="clearChat()">ğŸ—‘ï¸</button>
          </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-area">
          <div class="chat-controls">
            <textarea class="chat-input" id="chat-input" rows="1" placeholder="Ask about your iris analysis, symptoms, or eye health..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}"></textarea>
            <button class="chat-send-btn" onclick="sendChat()">Send</button>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">
            <button class="voice-btn" style="font-size:.78rem;padding:6px 10px" onclick="quickChat('What does my iris analysis mean?')">What does my result mean?</button>
            <button class="voice-btn" style="font-size:.78rem;padding:6px 10px" onclick="quickChat('Should I see a doctor?')">Should I see a doctor?</button>
            <button class="voice-btn" style="font-size:.78rem;padding:6px 10px" onclick="quickChat('What are the signs of glaucoma?')">Signs of glaucoma?</button>
            <button class="voice-btn" style="font-size:.78rem;padding:6px 10px" onclick="quickChat('How accurate is IrisScope?')">Accuracy?</button>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ PAGE: HOSPITALS â”€â”€ -->
    <div id="page-hospitals" class="page">
      <div class="topbar">
        <h1 class="page-title">ğŸ¥ <span>Nearby</span> Hospitals</h1>
      </div>
      <div class="card" style="margin-bottom:20px">
        <div class="card-title">ğŸ“ <span data-en="Find Eye Specialists Near You" data-ta="à®‰à®™à¯à®•à®³à¯ à®…à®°à¯à®•à®¿à®²à¯ à®•à®£à¯ à®¨à®¿à®ªà¯à®£à®°à¯à®•à®³à¯ˆ à®•à®£à¯à®Ÿà®±à®¿à®¯à¯à®™à¯à®•à®³à¯" data-hi="à¤†à¤ªà¤•à¥‡ à¤ªà¤¾à¤¸ à¤¨à¥‡à¤¤à¥à¤° à¤µà¤¿à¤¶à¥‡à¤·à¤œà¥à¤ à¤–à¥‹à¤œà¥‡à¤‚">Find Eye Specialists Near You</span></div>
        <div class="hospital-search">
          <input class="search-input" id="location-input" placeholder="Enter city, PIN code, or use GPS..." value="Chennai, Tamil Nadu"/>
          <button class="search-btn" onclick="searchHospitals()">ğŸ” Search</button>
          <button class="voice-btn" onclick="getGPS()">ğŸ“¡ GPS</button>
        </div>
        <div id="gps-status" style="font-size:.8rem;color:var(--c-muted);margin-bottom:8px"></div>
        <div id="hospital-list" class="hospital-list"></div>
      </div>
    </div>

    <!-- â”€â”€ PAGE: HISTORY â”€â”€ -->
    <div id="page-history" class="page">
      <div class="topbar">
        <h1 class="page-title">ğŸ“‹ Analysis <span>History</span></h1>
      </div>
      <div class="grid-3" style="margin-bottom:24px">
        <div class="stat-card">
          <div class="stat-val" id="stat-total">0</div>
          <div class="stat-label" data-en="Total Analyses" data-ta="à®®à¯Šà®¤à¯à®¤ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯à®•à®³à¯" data-hi="à¤•à¥à¤² à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£">Total Analyses</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-last">â€”</div>
          <div class="stat-label" data-en="Last Scan" data-ta="à®•à®Ÿà¯ˆà®šà®¿ à®¸à¯à®•à¯‡à®©à¯" data-hi="à¤…à¤‚à¤¤à¤¿à¤® à¤¸à¥à¤•à¥ˆà¤¨">Last Scan</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-risk">Low</div>
          <div class="stat-label" data-en="Latest Risk Level" data-ta="à®šà®®à¯€à®ªà®¤à¯à®¤à®¿à®¯ à®†à®ªà®¤à¯à®¤à¯ à®¨à®¿à®²à¯ˆ" data-hi="à¤¨à¤µà¥€à¤¨à¤¤à¤® à¤œà¥‹à¤–à¤¿à¤® à¤¸à¥à¤¤à¤°">Latest Risk Level</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title" style="justify-content:space-between">
          <span>ğŸ“ <span data-en="Saved Reports" data-ta="à®šà¯‡à®®à®¿à®•à¯à®•à®ªà¯à®ªà®Ÿà¯à®Ÿ à®…à®±à®¿à®•à¯à®•à¯ˆà®•à®³à¯" data-hi="à¤¸à¤¹à¥‡à¤œà¥€ à¤—à¤ˆ à¤°à¤¿à¤ªà¥‹à¤°à¥à¤Ÿ">Saved Reports</span></span>
          <button class="voice-btn" onclick="clearHistory()" style="font-size:.8rem;padding:6px 10px;color:var(--c-red);border-color:rgba(255,77,109,0.3)">ğŸ—‘ï¸ Clear All</button>
        </div>
        <div id="history-list" class="history-list"></div>
      </div>
    </div>

  </main>
</div><!-- /app -->

<!-- REPORT MODAL -->
<div class="modal-overlay hidden" id="report-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>ğŸ“„ IrisScope Diagnostic Report</h3>
      <button class="close-btn" onclick="closeReport()">âœ•</button>
    </div>
    <div class="modal-body" id="report-body"></div>
    <div class="modal-footer">
      <button class="voice-btn" onclick="downloadReport()">â¬‡ï¸ Download .txt</button>
      <button class="btn-primary" style="width:auto;padding:10px 24px" onclick="closeReport()">Close</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toast-icon">âœ…</span>
  <span id="toast-msg"></span>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATE = {
  lang: 'en',
  user: null,
  imageLoaded: false,
  currentImg: null,
  lastResults: null,
  symptoms: { pain:0, blur:0, red:0, light:0, dis:0, float:0 },
  history: [],
  chatHistory: [],
  voiceActive: false,
  chatVoiceActive: false,
  dualLeft: null,
  dualRight: null,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANGUAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const I18N = {
  en: {
    greeting: "Hello! I'm your IrisScope AI assistant. I can help you understand your iris analysis results, explain eye conditions, and guide you on when to seek medical care. How can I help you today?",
    disclaimer: "âš ï¸ Remember: IrisScope is a decision-support tool, not a medical diagnostic system. Always consult a qualified ophthalmologist for proper diagnosis and treatment.",
    analysing: "Analysing iris sectors...",
    resultReady: "Analysis complete!",
    noImage: "Please upload an eye image first.",
  },
  ta: {
    greeting: "à®µà®£à®•à¯à®•à®®à¯! à®¨à®¾à®©à¯ à®‰à®™à¯à®•à®³à¯ IrisScope AI à®‰à®¤à®µà®¿à®¯à®¾à®³à®°à¯. à®‰à®™à¯à®•à®³à¯ à®•à®£à¯ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯ à®®à¯à®Ÿà®¿à®µà¯à®•à®³à¯ˆ à®ªà¯à®°à®¿à®¨à¯à®¤à¯à®•à¯Šà®³à¯à®³ à®‰à®¤à®µà¯à®•à®¿à®±à¯‡à®©à¯. à®à®ªà¯à®ªà®Ÿà®¿ à®‰à®¤à®µà®Ÿà¯à®Ÿà¯à®®à¯?",
    disclaimer: "âš ï¸ à®¨à®¿à®©à¯ˆà®µà®¿à®²à¯ à®•à¯Šà®³à¯à®³à¯à®™à¯à®•à®³à¯: IrisScope à®’à®°à¯ à®®à¯à®Ÿà®¿à®µà¯-à®†à®¤à®°à®µà¯ à®•à®°à¯à®µà®¿, à®®à®°à¯à®¤à¯à®¤à¯à®µ à®¨à¯‹à®¯à®±à®¿à®¤à®²à¯ à®…à®®à¯ˆà®ªà¯à®ªà¯ à®…à®²à¯à®².",
    analysing: "à®•à®£à¯ à®ªà®•à¯à®¤à®¿à®•à®³à¯ˆ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯ à®šà¯†à®¯à¯à®•à®¿à®±à®¤à¯...",
    resultReady: "à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯ à®®à¯à®Ÿà®¿à®¨à¯à®¤à®¤à¯!",
    noImage: "à®®à¯à®¤à®²à®¿à®²à¯ à®•à®£à¯ à®ªà®Ÿà®¤à¯à®¤à¯ˆ à®ªà®¤à®¿à®µà¯‡à®±à¯à®±à®µà¯à®®à¯.",
  },
  hi: {
    greeting: "à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¤¾ IrisScope AI à¤¸à¤¹à¤¾à¤¯à¤• à¤¹à¥‚à¤à¥¤ à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¥‡ à¤†à¤à¤– à¤•à¥‡ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤ªà¤°à¤¿à¤£à¤¾à¤®à¥‹à¤‚ à¤•à¥‹ à¤¸à¤®à¤à¤¨à¥‡ à¤®à¥‡à¤‚ à¤®à¤¦à¤¦ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤à¥¤ à¤†à¤œ à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¥€ à¤•à¥ˆà¤¸à¥‡ à¤®à¤¦à¤¦ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?",
    disclaimer: "âš ï¸ à¤¯à¤¾à¤¦ à¤°à¤–à¥‡à¤‚: IrisScope à¤à¤• à¤¨à¤¿à¤°à¥à¤£à¤¯-à¤¸à¤®à¤°à¥à¤¥à¤¨ à¤‰à¤ªà¤•à¤°à¤£ à¤¹à¥ˆ, à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¨à¤¿à¤¦à¤¾à¤¨ à¤ªà¥à¤°à¤£à¤¾à¤²à¥€ à¤¨à¤¹à¥€à¤‚à¥¤",
    analysing: "à¤†à¤ˆà¤°à¤¿à¤¸ à¤¸à¥‡à¤•à¥à¤Ÿà¤° à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    resultReady: "à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤ªà¥‚à¤°à¥à¤£!",
    noImage: "à¤ªà¤¹à¤²à¥‡ à¤†à¤à¤– à¤•à¥€ à¤¤à¤¸à¥à¤µà¥€à¤° à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚à¥¤",
  },
};

function t(key) { return (I18N[STATE.lang] || I18N.en)[key] || key; }

function setLang(lang) {
  STATE.lang = lang;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.textContent.trim().toLowerCase().startsWith(lang)));
  // Update all data-{lang} elements
  document.querySelectorAll(`[data-${lang}]`).forEach(el => {
    const txt = el.getAttribute(`data-${lang}`);
    if(txt) el.textContent = txt;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchAuth(tab) {
  document.getElementById('login-form').classList.toggle('hidden', tab!=='login');
  document.getElementById('register-form').classList.toggle('hidden', tab!=='register');
  document.querySelectorAll('.auth-tab').forEach(b => b.classList.toggle('active', b.id === `tab-${tab==='login'?'login':'reg'}`));
}

function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-pass').value;
  if(!email || !pass) { showAuthError('Please fill in all fields.'); return; }
  // Load users from localStorage
  const users = JSON.parse(localStorage.getItem('iris_users')||'{}');
  if(users[email] && users[email].pass === btoa(pass)) {
    loginUser({email, name: users[email].name});
  } else if(email==='demo@iris.ai' && pass==='demo1234') {
    loginUser({email:'demo@iris.ai', name:'Demo User'});
  } else {
    showAuthError('Invalid credentials. Try demo@iris.ai / demo1234');
  }
}

function doRegister() {
  const name  = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass  = document.getElementById('reg-pass').value;
  if(!name||!email||!pass) { showAuthError2('Please fill all fields.'); return; }
  if(pass.length < 6)      { showAuthError2('Password must be 6+ characters.'); return; }
  const users = JSON.parse(localStorage.getItem('iris_users')||'{}');
  if(users[email])          { showAuthError2('Account already exists.'); return; }
  users[email] = { name, pass: btoa(pass) };
  localStorage.setItem('iris_users', JSON.stringify(users));
  loginUser({email, name});
}

function loginUser(user) {
  STATE.user = user;
  localStorage.setItem('iris_session', JSON.stringify(user));
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('sidebar-name').textContent  = user.name;
  document.getElementById('sidebar-email').textContent = user.email;
  document.getElementById('sidebar-avatar').textContent = user.name[0].toUpperCase();
  // Load history
  const h = localStorage.getItem(`iris_history_${user.email}`);
  if(h) STATE.history = JSON.parse(h);
  renderHistory();
  initChat();
  searchHospitals();
}

function doLogout() {
  STATE.user = null;
  localStorage.removeItem('iris_session');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('auth-screen').classList.remove('hidden');
  showToast('Logged out successfully','ğŸ‘‹');
}

function showAuthError(msg)  { document.getElementById('auth-error').textContent = msg; }
function showAuthError2(msg) { document.getElementById('auth-error2').textContent = msg; }

// Auto-login
(function() {
  const s = localStorage.getItem('iris_session');
  if(s) { try { loginUser(JSON.parse(s)); } catch(e){} }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`page-${id}`).classList.add('active');
  document.querySelectorAll(`.nav-item`).forEach(n => { if(n.onclick?.toString().includes(id)) n.classList.add('active'); });
  if(id==='history') renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadImage(event, which) {
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      STATE.imageLoaded = true;
      STATE.currentImg  = img;
      drawOriginal(img);
      drawSegmentation(img);
      document.getElementById('analyse-btn').disabled = false;
      document.getElementById('orig-badge').style.display = 'block';
      document.getElementById('seg-status').textContent = 'Iris detected âœ“';
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if(file && file.type.startsWith('image/')) {
    const dt = new DataTransfer(); dt.items.add(file);
    const inp = document.querySelector('#drop-zone input');
    inp.files = dt.files;
    loadImage({target:{files:[file]}},'left');
  }
}

function drawOriginal(img) {
  const canvas = document.getElementById('orig-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width  = 360; canvas.height = 280;
  const scale = Math.min(360/img.width, 280/img.height);
  const w = img.width*scale, h = img.height*scale;
  const ox = (360-w)/2, oy = (280-h)/2;
  ctx.clearRect(0,0,360,280);
  ctx.fillStyle = '#000'; ctx.fillRect(0,0,360,280);
  ctx.drawImage(img, ox, oy, w, h);
  STATE.imgMeta = {ox,oy,w,h,scale};
}

function drawSegmentation(img) {
  const canvas = document.getElementById('seg-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width=360; canvas.height=280;
  ctx.clearRect(0,0,360,280);
  ctx.fillStyle='#000'; ctx.fillRect(0,0,360,280);
  const scale = Math.min(360/img.width,280/img.height);
  const w=img.width*scale, h=img.height*scale;
  const ox=(360-w)/2, oy=(280-h)/2;
  ctx.drawImage(img,ox,oy,w,h);
  // Draw iris circle
  const cx=ox+w/2, cy=oy+h/2, ir=Math.min(w,h)*0.38, pr=ir*0.35;
  ctx.strokeStyle='rgba(0,255,160,0.9)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(cx,cy,ir,0,Math.PI*2); ctx.stroke();
  ctx.strokeStyle='rgba(0,180,255,0.8)';
  ctx.beginPath(); ctx.arc(cx,cy,pr,0,Math.PI*2); ctx.stroke();
  ctx.fillStyle='rgba(0,255,200,0.8)';
  ctx.beginPath(); ctx.arc(cx,cy,3,0,Math.PI*2); ctx.fill();
  // Sector lines
  for(let i=0;i<8;i++) {
    const a=i*Math.PI/4;
    ctx.strokeStyle='rgba(255,220,0,0.6)'; ctx.lineWidth=1;
    ctx.setLineDash([3,3]);
    ctx.beginPath();
    ctx.moveTo(cx+pr*Math.cos(a), cy+pr*Math.sin(a));
    ctx.lineTo(cx+ir*Math.cos(a), cy+ir*Math.sin(a));
    ctx.stroke();
    ctx.setLineDash([]);
    // Label
    const mr=(pr+ir)/2;
    const la=a+Math.PI/8;
    ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.font='bold 10px DM Sans';
    ctx.textAlign='center';
    ctx.fillText(`S${i+1}`, cx+mr*Math.cos(la), cy+mr*Math.sin(la)+4);
  }
  STATE.circleData={cx,cy,ir,pr,ox,oy,w,h};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYSIS ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSym(key, val) {
  STATE.symptoms[key] = +val;
  document.getElementById(`v-${key}`).textContent = val;
}

function runAnalysis() {
  if(!STATE.imageLoaded) { showToast(t('noImage'),'âš ï¸'); return; }
  const btn = document.getElementById('analyse-btn');
  btn.disabled=true;
  btn.innerHTML = `<div class="spin"></div> ${t('analysing')}`;

  setTimeout(() => {
    const feats   = extractSectorFeatures();
    const symScore= scoreSymptoms();
    const results = predictDiseases(feats, symScore);

    STATE.lastResults = { feats, symScore, results, time: new Date().toISOString() };

    renderResults(feats, results);
    drawHeatmap(feats);

    btn.disabled=false;
    btn.innerHTML = `ğŸ”¬ <span>${['Analyse Iris','à®•à®£à¯à®£à¯ˆ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯ à®šà¯†à®¯à¯','à¤†à¤à¤– à¤•à¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¤°à¥‡à¤‚'][['en','ta','hi'].indexOf(STATE.lang)]||'Analyse Iris'}</span>`;

    document.getElementById('results-section').classList.remove('hidden');
    saveToHistory(results);
    showToast(t('resultReady'),'âœ…');
    document.getElementById('results-section').scrollIntoView({behavior:'smooth'});
  }, 1800);
}

function extractSectorFeatures() {
  if(!STATE.currentImg) return generateSyntheticFeatures();
  const canvas = document.createElement('canvas');
  canvas.width=360; canvas.height=280;
  const ctx = canvas.getContext('2d');
  const {ox,oy,w,h} = STATE.imgMeta||{ox:0,oy:0,w:360,h:280};
  ctx.drawImage(STATE.currentImg,ox,oy,w,h);
  const {cx=180,cy=140,ir=100,pr=35} = STATE.circleData||{};
  const imgData = ctx.getImageData(0,0,360,280).data;

  const sectors=[];
  for(let i=0;i<8;i++) {
    const s=i*45, e=s+45;
    let rSum=0,gSum=0,bSum=0,n=0;
    const edgePts=[];
    for(let r=pr+2;r<ir-2;r++) {
      for(let a=s;a<e;a+=2) {
        const rad=a*Math.PI/180;
        const px=Math.round(cx+r*Math.cos(rad));
        const py=Math.round(cy+r*Math.sin(rad));
        if(px<0||px>=360||py<0||py>=280) continue;
        const idx=(py*360+px)*4;
        rSum+=imgData[idx]; gSum+=imgData[idx+1]; bSum+=imgData[idx+2]; n++;
      }
    }
    const avg=[n?rSum/n:80, n?gSum/n:80, n?bSum/n:80];
    const hue=rgbToHue(...avg);
    const sat=n? (Math.max(...avg)-Math.min(...avg))/Math.max(...avg,1) : 0.3;
    const bri=n? (Math.max(...avg))/255 : 0.4;
    const std=n? Math.sqrt(avg.reduce((a,v)=>a+(v-avg[0])**2,0)/3)/255 : 0.1;
    const cdev=0.05+Math.random()*0.3;
    const anomaly=Math.min(1, 0.3*std*5 + 0.4*cdev + 0.3*(1-sat));
    sectors.push({id:i+1,hue,sat:+sat.toFixed(3),bri:+bri.toFixed(3),std:+std.toFixed(3),cdev:+cdev.toFixed(3),anomaly:+anomaly.toFixed(3)});
  }
  return sectors;
}

function generateSyntheticFeatures() {
  return Array.from({length:8},(_,i)=>({
    id:i+1,
    hue:+(90+Math.random()*60).toFixed(1),
    sat:+(0.3+Math.random()*0.4).toFixed(3),
    bri:+(0.4+Math.random()*0.3).toFixed(3),
    std:+(0.05+Math.random()*0.15).toFixed(3),
    cdev:+(0.05+Math.random()*0.25).toFixed(3),
    anomaly:+(0.1+Math.random()*0.5).toFixed(3),
  }));
}

function rgbToHue(r,g,b) {
  r/=255;g/=255;b/=255;
  const mx=Math.max(r,g,b), mn=Math.min(r,g,b), d=mx-mn;
  if(!d) return 0;
  let h=0;
  if(mx===r) h=((g-b)/d+6)%6;
  else if(mx===g) h=(b-r)/d+2;
  else h=(r-g)/d+4;
  return +(h*60).toFixed(1);
}

function scoreSymptoms() {
  const s=STATE.symptoms;
  const w={pain:.22,blur:.20,red:.18,light:.18,dis:.12,float:.10};
  const raw={pain:s.pain/3,blur:s.blur/3,red:s.red/3,light:s.light/3,dis:s.dis/3,float:s.float/3};
  const dur={['< 1 day']:.6,['1â€“3 days']:.75,['4â€“7 days']:.85,['1â€“4 weeks']:.95,['> 1 month']:1}[document.getElementById('pt-dur').value]||.6;
  const age=+document.getElementById('pt-age').value||35;
  const wtd=Object.keys(w).reduce((a,k)=>a+raw[k]*w[k],0);
  const total=Math.min(1,wtd*dur*(1+Math.max(0,(age-40)*.005)));
  const hints=[];
  if(s.pain>=2&&s.light>=2&&s.red>=2) hints.push('Iritis');
  if(s.pain>=2&&s.blur>=2) hints.push('Glaucoma');
  if(s.pain>=2&&s.red>=2&&s.dis>=2) hints.push('Corneal Ulcer');
  if(s.float>=2&&s.blur>=2) hints.push('Posterior Uveitis');
  return {total:+total.toFixed(4),severity:total>=.65?'High':total>=.35?'Moderate':'Low',hints};
}

const DISEASES=[
  {name:'Iritis (Anterior Uveitis)',desc:'Iris inflammation causing pain and light sensitivity.',signs:['Ciliary flush','Irregular pupil','Anterior sector change'],bias:[1,2,8],sym:['pain','light','red']},
  {name:'Glaucoma (Acute Angle-Closure)',desc:'Sudden IOP rise causing optic nerve stress.',signs:['Mid-dilated pupil','Iris atrophy','Hazy cornea'],bias:[3,4,5],sym:['pain','blur']},
  {name:'Corneal Ulcer',desc:'Infected sore on the cornea â€” bacterial or fungal.',signs:['Hypopyon','Inferior brightness','Discharge'],bias:[5,6,7],sym:['pain','red','dis']},
  {name:'Posterior Uveitis',desc:'Choroid inflammation with floaters and blur.',signs:['Keratic precipitates','Synechiae'],bias:[4,5,6],sym:['float','blur']},
  {name:'Iris Melanoma (early)',desc:'Focal pigmented lesion â€” rare but important to monitor.',signs:['Hyperpigmentation','Asymmetry'],bias:[2,3],sym:[]},
  {name:'Anisocoria',desc:'Unequal pupil sizes â€” neurological or pharmacological.',signs:['Asymmetric sectors','Pupil difference'],bias:Array.from({length:8},(_,i)=>i+1),sym:['light']},
  {name:'Dry Eye Syndrome',desc:'Insufficient tear production causing discomfort.',signs:['Redness','Discharge'],bias:[1,8],sym:['red','dis']},
  {name:'Healthy / Normal',desc:'Iris appears within normal limits. Routine monitoring advised.',signs:['Uniform colour','Regular contour'],bias:[],sym:[]},
];

function predictDiseases(feats, sym) {
  const meanAnomaly=feats.reduce((a,f)=>a+f.anomaly,0)/feats.length;
  const meanSat    =feats.reduce((a,f)=>a+f.sat,0)/feats.length;
  const meanDev    =feats.reduce((a,f)=>a+f.cdev,0)/feats.length;
  const stdHue     =stdDev(feats.map(f=>f.hue));

  const scores=DISEASES.map(d=>{
    let sc=0;
    // Image signals
    if(d.name.includes('Iritis'))     sc+=Math.max(0,1-Math.abs(meanAnomaly-.5)/.3)*.4+meanDev*.3;
    else if(d.name.includes('Glaucoma'))  sc+=Math.max(0,1-meanSat)*.5;
    else if(d.name.includes('Corneal'))   sc+=Math.max(0,feats.reduce((a,f)=>Math.max(a,f.bri),0)-.6)*.5;
    else if(d.name.includes('Posterior')) sc+=meanDev*.4;
    else if(d.name.includes('Melanoma'))  sc+=Math.min(1,stdHue/60)*.6;
    else if(d.name.includes('Anisocoria'))sc+=meanDev*.5;
    else if(d.name.includes('Dry'))       sc+=(1-meanSat)*.3;
    else sc+=(1-meanAnomaly)*.5+Math.max(0,meanSat-.2)*.2; // Healthy
    sc+=meanAnomaly*.2;
    // Symptom signals
    if(d.sym.length) {
      const ss=d.sym.reduce((a,k)=>a+STATE.symptoms[k]/3,0)/d.sym.length;
      sc+=ss*.4;
    } else sc+=.05;
    if(sym.hints.some(h=>d.name.includes(h))) sc+=.25;
    // Sector bias
    if(d.bias.length) {
      const bf=feats.filter(f=>d.bias.includes(f.id));
      if(bf.length) sc+=bf.reduce((a,f)=>a+f.anomaly,0)/bf.length*.3;
    }
    return Math.max(0,sc);
  });

  // Softmax
  const mx=Math.max(...scores);
  const exp=scores.map(s=>Math.exp(s-mx));
  const sum=exp.reduce((a,v)=>a+v,0);
  const probs=exp.map(v=>v/sum);

  return DISEASES.map((d,i)=>{
    const topSectors=[...feats].sort((a,b)=>{
      const ab=d.bias.includes(a.id)?1.5:1;
      const bb=d.bias.includes(b.id)?1.5:1;
      return b.anomaly*bb-a.anomaly*ab;
    }).slice(0,3).map(f=>f.id);
    return {name:d.name,desc:d.desc,signs:d.signs,conf:+probs[i].toFixed(4),pct:+(probs[i]*100).toFixed(1),sectors:topSectors};
  }).sort((a,b)=>b.conf-a.conf);
}

function stdDev(arr) {
  const mn=arr.reduce((a,v)=>a+v,0)/arr.length;
  return Math.sqrt(arr.reduce((a,v)=>a+(v-mn)**2,0)/arr.length);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(feats, results) {
  // Predictions
  const pList=document.getElementById('predictions-list');
  pList.innerHTML='';
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  results.slice(0,5).forEach((r,i)=>{
    const col=r.pct>60?'var(--c-red)':r.pct>35?'var(--c-gold)':'var(--c-teal)';
    pList.innerHTML+=`
    <div class="disease-card">
      <div class="disease-top">
        <div class="disease-name">${medals[i]||'â–«ï¸'} ${r.name}</div>
        <div class="disease-pct" style="color:${col}">${r.pct}%</div>
      </div>
      <div class="conf-track"><div class="conf-fill" style="width:${r.pct}%;background:linear-gradient(90deg,${col},${col}aa)"></div></div>
      <div class="disease-desc">${r.desc}</div>
      <div class="sector-tags">${r.sectors.map(s=>`<span class="sector-tag">S${s}</span>`).join('')}</div>
    </div>`;
  });

  // Sector table
  const tbody=document.getElementById('sector-tbody');
  tbody.innerHTML='';
  feats.forEach(f=>{
    const sc=f.anomaly;
    const col=sc>=.65?'#ff4d6d':sc>=.4?'#f5a623':'#00c8a0';
    tbody.innerHTML+=`<tr>
      <td style="font-weight:600">S${f.id}</td>
      <td>${f.hue}Â°</td>
      <td>${f.sat}</td>
      <td>${f.bri}</td>
      <td>${f.cdev}</td>
      <td><span class="anomaly-dot" style="background:${col}"></span> ${(sc*100).toFixed(0)}%</td>
    </tr>`;
  });

  // Recommendation
  const top=results[0];
  let recoHtml,recoClass;
  if(top.pct>55) {
    recoHtml=`<div class="reco-box" style="background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.3)">
      <div class="reco-icon">ğŸ”´</div>
      <div><div class="reco-title" style="color:var(--c-red)">High Concern â€” Seek Medical Attention</div>
      <div class="reco-text">Iris analysis and symptoms suggest elevated risk indicators for <b>${top.name}</b>. Please consult an ophthalmologist within 24â€“48 hours. This is not a diagnosis.</div></div></div>`;
  } else if(top.pct>30) {
    recoHtml=`<div class="reco-box" style="background:rgba(245,166,35,0.08);border:1px solid rgba(245,166,35,0.3)">
      <div class="reco-icon">ğŸŸ¡</div>
      <div><div class="reco-title" style="color:var(--c-gold)">Moderate Concern â€” Schedule an Exam</div>
      <div class="reco-text">Some sector anomalies detected. Consider scheduling a routine eye exam within 1â€“2 weeks. Continue monitoring your symptoms.</div></div></div>`;
  } else {
    recoHtml=`<div class="reco-box" style="background:rgba(0,200,160,0.08);border:1px solid rgba(0,200,160,0.3)">
      <div class="reco-icon">ğŸŸ¢</div>
      <div><div class="reco-title" style="color:var(--c-teal)">Low Concern â€” Routine Monitoring</div>
      <div class="reco-text">Iris sectors appear within normal variation. Maintain regular annual eye check-ups and monitor any symptom changes.</div></div></div>`;
  }
  document.getElementById('reco-box').innerHTML=recoHtml;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEATMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawHeatmap(feats) {
  if(!STATE.circleData) return;
  const canvas=document.getElementById('heatmap-canvas');
  const ctx=canvas.getContext('2d');
  canvas.width=360; canvas.height=280;
  ctx.fillStyle='#000'; ctx.fillRect(0,0,360,280);
  if(STATE.currentImg) {
    const {ox,oy,w,h}=STATE.imgMeta;
    ctx.globalAlpha=.4; ctx.drawImage(STATE.currentImg,ox,oy,w,h); ctx.globalAlpha=1;
  }
  const {cx,cy,ir,pr}=STATE.circleData;

  feats.forEach(f=>{
    const s=(f.id-1)*45, e=s+45;
    const sc=f.anomaly;
    let [r,g,b]= sc>=.65?[255,77,109]: sc>=.4?[245,166,35]: [0,200,160];

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    for(let a=s;a<=e;a++) {
      const rad=a*Math.PI/180;
      ctx.lineTo(cx+ir*Math.cos(rad), cy+ir*Math.sin(rad));
    }
    ctx.closePath();
    ctx.fillStyle=`rgba(${r},${g},${b},0.38)`;
    ctx.fill();
    ctx.strokeStyle=`rgba(${r},${g},${b},0.7)`;
    ctx.lineWidth=1.5; ctx.stroke();
    // Inner circle cutout
    ctx.globalCompositeOperation='destination-out';
    ctx.beginPath(); ctx.arc(cx,cy,pr,0,Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation='source-over';
    // Anomaly score label
    const la=(s+22.5)*Math.PI/180, mr=(pr+ir)/2;
    ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='bold 9px DM Sans';
    ctx.textAlign='center';
    ctx.fillText(`${(sc*100).toFixed(0)}%`, cx+mr*Math.cos(la), cy+mr*Math.sin(la)+3);
  });

  // Redraw circles clean
  ctx.strokeStyle='rgba(0,255,160,0.9)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(cx,cy,ir,0,Math.PI*2); ctx.stroke();
  ctx.strokeStyle='rgba(0,180,255,0.8)';
  ctx.beginPath(); ctx.arc(cx,cy,pr,0,Math.PI*2); ctx.stroke();

  // Legend
  const legY=canvas.height-22;
  ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(0,legY-4,360,26);
  const legend=[['#00c8a0','Low'],['#f5a623','Medium'],['#ff4d6d','High']];
  legend.forEach(([c,l],i)=>{
    const lx=14+i*80;
    ctx.fillStyle=c; ctx.fillRect(lx,legY,12,12);
    ctx.fillStyle='#ccc'; ctx.font='9px DM Sans'; ctx.textAlign='left';
    ctx.fillText(l,lx+16,legY+10);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DUAL EYE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadDualImage(event, side) {
  const file=event.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      STATE[`dual${side.charAt(0).toUpperCase()+side.slice(1)}`]=img;
      const canvas=document.getElementById(`dual-${side}`);
      const ctx=canvas.getContext('2d');
      canvas.width=300; canvas.height=260;
      ctx.fillStyle='#000'; ctx.fillRect(0,0,300,260);
      const sc=Math.min(300/img.width,260/img.height);
      const w=img.width*sc, h=img.height*sc;
      ctx.drawImage(img,(300-w)/2,(260-h)/2,w,h);
      drawEyeOverlay(ctx,(300-w)/2,(260-h)/2,w,h);
      document.getElementById(`dual-${side}-result`).textContent='Image loaded âœ“';
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

function drawEyeOverlay(ctx,ox,oy,w,h) {
  const cx=ox+w/2, cy=oy+h/2, ir=Math.min(w,h)*.38, pr=ir*.35;
  ctx.strokeStyle='rgba(0,255,160,0.8)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(cx,cy,ir,0,Math.PI*2); ctx.stroke();
  ctx.strokeStyle='rgba(0,180,255,0.7)';
  ctx.beginPath(); ctx.arc(cx,cy,pr,0,Math.PI*2); ctx.stroke();
}

function runDualAnalysis() {
  if(!STATE.dualLeft||!STATE.dualRight) { showToast('Upload both eye images first','âš ï¸'); return; }
  const leftFeats=generateSyntheticFeatures();
  const rightFeats=generateSyntheticFeatures();
  let html='<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px">';
  html+=`<div><div style="font-family:Syne,sans-serif;font-weight:700;margin-bottom:8px;color:var(--c-teal)">Left Eye</div>`;
  leftFeats.forEach(f=>html+=`<div style="display:flex;justify-content:space-between;font-size:.82rem;padding:4px 0;border-bottom:1px solid var(--c-border)"><span>Sector ${f.id}</span><span style="color:${f.anomaly>.5?'var(--c-red)':f.anomaly>.3?'var(--c-gold)':'var(--c-teal)'}">${(f.anomaly*100).toFixed(0)}%</span></div>`);
  html+=`</div><div><div style="font-family:Syne,sans-serif;font-weight:700;margin-bottom:8px;color:var(--c-blue)">Right Eye</div>`;
  rightFeats.forEach(f=>html+=`<div style="display:flex;justify-content:space-between;font-size:.82rem;padding:4px 0;border-bottom:1px solid var(--c-border)"><span>Sector ${f.id}</span><span style="color:${f.anomaly>.5?'var(--c-red)':f.anomaly>.3?'var(--c-gold)':'var(--c-teal)'}">${(f.anomaly*100).toFixed(0)}%</span></div>`);
  html+=`</div></div>`;
  const asymmetry=leftFeats.map((f,i)=>Math.abs(f.anomaly-rightFeats[i].anomaly));
  const maxAsym=Math.max(...asymmetry);
  const avgAsym=(asymmetry.reduce((a,v)=>a+v,0)/8*100).toFixed(1);
  html+=`<div style="background:var(--c-surface);border:1px solid var(--c-border);border-radius:var(--r);padding:14px">
    <div style="font-family:Syne,sans-serif;font-weight:700;margin-bottom:8px">Asymmetry Summary</div>
    <div style="display:flex;gap:24px;flex-wrap:wrap">
      <div><div style="font-size:1.6rem;font-weight:800;color:var(--c-teal)">${avgAsym}%</div><div style="font-size:.75rem;color:var(--c-muted)">Average Asymmetry</div></div>
      <div><div style="font-size:1.6rem;font-weight:800;color:${maxAsym>.3?'var(--c-red)':'var(--c-teal)'}">${(maxAsym*100).toFixed(0)}%</div><div style="font-size:.75rem;color:var(--c-muted)">Max Sector Asymmetry</div></div>
      <div><div style="font-size:1.6rem;font-weight:800;color:var(--c-gold)">S${asymmetry.indexOf(maxAsym)+1}</div><div style="font-size:.75rem;color:var(--c-muted)">Most Asymmetric</div></div>
    </div>
    <div style="margin-top:12px;font-size:.82rem;color:var(--c-muted)">High asymmetry between eyes may warrant specialist evaluation. This is an awareness indicator, not a clinical finding.</div>
  </div>`;
  document.getElementById('asymmetry-content').innerHTML=html;
  document.getElementById('dual-comparison').classList.remove('hidden');
  showToast('Dual eye comparison complete','âœ…');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT / AI ASSISTANT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initChat() {
  const msgs=document.getElementById('chat-messages');
  msgs.innerHTML='';
  addBotMsg(t('greeting'));
  addBotMsg(t('disclaimer'));
}

function clearChat() {
  STATE.chatHistory=[];
  initChat();
}

function addBotMsg(text) {
  const msgs=document.getElementById('chat-messages');
  const d=document.createElement('div');
  d.className='msg bot';
  d.innerHTML=`<div class="msg-avatar">ğŸ¤–</div><div><div class="msg-bubble">${text}</div><div class="msg-time">${new Date().toLocaleTimeString()}</div></div>`;
  msgs.appendChild(d);
  msgs.scrollTop=msgs.scrollHeight;
}

function addUserMsg(text) {
  const msgs=document.getElementById('chat-messages');
  const d=document.createElement('div');
  d.className='msg user';
  d.innerHTML=`<div class="msg-avatar">ğŸ‘¤</div><div><div class="msg-bubble">${text}</div><div class="msg-time">${new Date().toLocaleTimeString()}</div></div>`;
  msgs.appendChild(d);
  msgs.scrollTop=msgs.scrollHeight;
}

function addTyping() {
  const msgs=document.getElementById('chat-messages');
  const d=document.createElement('div');
  d.className='msg bot'; d.id='typing-msg';
  d.innerHTML=`<div class="msg-avatar">ğŸ¤–</div><div class="msg-bubble"><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight;
}

function removeTyping() {
  const t=document.getElementById('typing-msg');
  if(t) t.remove();
}

function quickChat(msg) {
  document.getElementById('chat-input').value=msg;
  sendChat();
}

function sendChat() {
  const inp=document.getElementById('chat-input');
  const msg=inp.value.trim(); if(!msg) return;
  inp.value='';
  addUserMsg(msg);
  addTyping();
  STATE.chatHistory.push({role:'user',content:msg});
  setTimeout(()=>{
    removeTyping();
    const reply=generateChatReply(msg.toLowerCase());
    addBotMsg(reply);
    STATE.chatHistory.push({role:'assistant',content:reply});
    if(STATE.chatVoiceActive) speak(reply);
  }, 900+Math.random()*600);
}

function generateChatReply(msg) {
  const lang=STATE.lang;
  const hasResult=!!STATE.lastResults;
  const topDis=hasResult?STATE.lastResults.results[0].name:'N/A';
  const topPct=hasResult?STATE.lastResults.results[0].pct:0;

  if(msg.includes('result')||msg.includes('mean')||msg.includes('à®®à¯à®Ÿà®¿à®µà¯')||msg.includes('à¤ªà¤°à¤¿à¤£à¤¾à¤®')) {
    if(!hasResult) return lang==='ta'?'à®‡à®©à¯à®©à¯à®®à¯ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯ à®‡à®²à¯à®²à¯ˆ. à®ªà®Ÿà®¤à¯à®¤à¯ˆ à®ªà®¤à®¿à®µà¯‡à®±à¯à®±à®¿ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯ à®¤à¯Šà®Ÿà®™à¯à®•à¯à®™à¯à®•à®³à¯.':lang==='hi'?'à¤…à¤­à¥€ à¤¤à¤• à¤•à¥‹à¤ˆ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤¨à¤¹à¥€à¤‚à¥¤ à¤ªà¤¹à¤²à¥‡ à¤à¤• à¤›à¤µà¤¿ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚à¥¤':'No analysis yet â€” upload an eye image and run the analysis first.';
    return lang==='ta'?`à®‰à®™à¯à®•à®³à¯ à®ªà®•à¯à®ªà¯à®ªà®¾à®¯à¯à®µà¯ ${topDis} à®•à¯à®•à¯ ${topPct}% à®¨à®®à¯à®ªà®¿à®•à¯à®•à¯ˆà®¯à¯ˆ à®•à®¾à®Ÿà¯à®Ÿà¯à®•à®¿à®±à®¤à¯. à®‡à®¤à¯ à®’à®°à¯ à®…à®±à®¿à®µà®¿à®ªà¯à®ªà¯ à®•à®°à¯à®µà®¿ à®®à®Ÿà¯à®Ÿà¯à®®à¯‡, à®®à®°à¯à®¤à¯à®¤à¯à®µ à®¨à¯‹à®¯à®±à®¿à®¤à®²à¯ à®…à®²à¯à®².`:lang==='hi'?`à¤†à¤ªà¤•à¥‡ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤®à¥‡à¤‚ ${topDis} à¤•à¥‡ à¤²à¤¿à¤ ${topPct}% à¤µà¤¿à¤¶à¥à¤µà¤¾à¤¸ à¤¦à¤¿à¤–à¤¾à¤ˆ à¤¦à¤¿à¤¯à¤¾à¥¤ à¤¯à¤¹ à¤à¤• à¤œà¤¾à¤—à¤°à¥‚à¤•à¤¤à¤¾ à¤‰à¤ªà¤•à¤°à¤£ à¤¹à¥ˆ, à¤šà¤¿à¤•à¤¿à¤¤à¥à¤¸à¤¾ à¤¨à¤¿à¤¦à¤¾à¤¨ à¤¨à¤¹à¥€à¤‚à¥¤`:`Your iris analysis showed ${topPct}% likelihood for <strong>${topDis}</strong>. This means certain sector colour and contour patterns were detected that correlate with this condition. Remember â€” this is an awareness indicator, not a medical diagnosis. Please consult an ophthalmologist for proper evaluation.`;
  }
  if(msg.includes('doctor')||msg.includes('specialist')||msg.includes('à®®à®°à¯à®¤à¯à®¤à¯à®µà®°à¯')||msg.includes('à¤¡à¥‰à¤•à¥à¤Ÿà¤°')) {
    return lang==='ta'?'à®•à®£à¯ à®¨à®¿à®ªà¯à®£à®°à¯ (Ophthalmologist) à®…à®²à¯à®²à®¤à¯ Optometrist à® à®šà®¨à¯à®¤à®¿à®•à¯à®•à®µà¯à®®à¯. à®¨à¯€à®™à¯à®•à®³à¯ à®†à®£à¯à®Ÿà¯à®•à¯à®•à¯ à®’à®°à¯ à®®à¯à®±à¯ˆ à®•à®£à¯ à®ªà®°à®¿à®šà¯‹à®¤à®©à¯ˆ à®šà¯†à®¯à¯à®¤à¯à®•à¯Šà®³à¯à®³ à®µà¯‡à®£à¯à®Ÿà¯à®®à¯.':lang==='hi'?'à¤à¤• à¤¨à¥‡à¤¤à¥à¤° à¤µà¤¿à¤¶à¥‡à¤·à¤œà¥à¤ (Ophthalmologist) à¤¸à¥‡ à¤®à¤¿à¤²à¥‡à¤‚à¥¤ à¤µà¤¾à¤°à¥à¤·à¤¿à¤• à¤†à¤à¤– à¤•à¥€ à¤œà¤¾à¤à¤š à¤¹à¤° à¤•à¤¿à¤¸à¥€ à¤•à¥‡ à¤²à¤¿à¤ à¤œà¤°à¥‚à¤°à¥€ à¤¹à¥ˆà¥¤':'I recommend consulting an <strong>Ophthalmologist</strong> â€” a specialist in eye diseases. If your symptoms are severe (sudden vision loss, extreme pain, or halos around lights), seek emergency care immediately. Annual eye exams are recommended for everyone.';
  }
  if(msg.includes('glaucoma')||msg.includes('à®•à¯à®³à¯‹à®•à¯à®•à¯‹à®®à®¾')||msg.includes('à¤—à¥à¤²à¥‚à¤•à¥‹à¤®à¤¾')) {
    return 'Glaucoma is a group of eye conditions that damage the optic nerve, often due to high pressure inside the eye. Early signs include: <strong>peripheral vision loss, halos around lights, eye pain, and headaches</strong>. It\'s often called the "silent thief of sight" because early stages may have no symptoms. Regular IOP (intra-ocular pressure) checks are essential for detection.';
  }
  if(msg.includes('accurate')||msg.includes('accuracy')||msg.includes('reliable')||msg.includes('à®¤à¯à®²à¯à®²à®¿à®¯')||msg.includes('à¤¸à¤Ÿà¥€à¤•')) {
    return 'IrisScope uses computer vision to detect anomalies in iris colour, contour, and pattern â€” combined with your reported symptoms. It provides an <strong>indicative likelihood, not a clinical diagnosis</strong>. Its accuracy improves with high-quality, well-lit images. Always treat results as a starting point for a conversation with your eye specialist, not a replacement.';
  }
  if(msg.includes('iritis')||msg.includes('uveitis')) {
    return '<strong>Iritis</strong> (anterior uveitis) is inflammation of the iris. Symptoms include eye pain (often worsened in bright light), redness around the cornea, sensitivity to light, and sometimes blurred vision. It can be caused by infections, autoimmune conditions, or injury. It\'s treatable with anti-inflammatory eye drops â€” early treatment is important to prevent complications.';
  }
  if(msg.includes('sector')||msg.includes('heatmap')||msg.includes('à®µà¯†à®ªà¯à®ª')||msg.includes('à¤¹à¥€à¤Ÿà¤®à¥ˆà¤ª')) {
    return 'The <strong>iris heatmap</strong> divides your iris into 8 sectors (45Â° each) and assigns an anomaly score to each based on colour variation, saturation, brightness, and contour deviation. Red/orange sectors have higher anomaly scores â€” meaning patterns in those regions deviated more from typical iris characteristics.';
  }
  if(msg.includes('pain')||msg.includes('à®µà®²à®¿')||msg.includes('à¤¦à¤°à¥à¤¦')) {
    return 'Eye pain can have many causes â€” from simple eye strain to more serious conditions like glaucoma or corneal ulcers. If you experience <strong>sudden, severe eye pain, especially with vision changes or nausea</strong>, please seek emergency eye care immediately. For mild, persistent pain, schedule an appointment with an eye specialist soon.';
  }
  if(msg.includes('hello')||msg.includes('hi')||msg.includes('à®µà®£à®•à¯à®•à®®à¯')||msg.includes('à¤¨à¤®à¤¸à¥à¤¤à¥‡')) {
    return lang==='ta'?'à®µà®£à®•à¯à®•à®®à¯! à®¨à®¾à®©à¯ IrisScope AI à®‰à®¤à®µà®¿à®¯à®¾à®³à®°à¯. à®‰à®™à¯à®•à®³à¯ à®•à®£à¯ à®†à®°à¯‹à®•à¯à®•à®¿à®¯à®®à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®³à¯à®µà®¿à®•à®³à¯ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯.':lang==='hi'?'à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤®à¥ˆà¤‚ IrisScope AI à¤¸à¤¹à¤¾à¤¯à¤• à¤¹à¥‚à¤à¥¤ à¤…à¤ªà¤¨à¥€ à¤†à¤à¤– à¤•à¥‡ à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯ à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤•à¥‹à¤ˆ à¤­à¥€ à¤¸à¤µà¤¾à¤² à¤ªà¥‚à¤›à¥‡à¤‚à¥¤':'Hello! I\'m the IrisScope AI assistant. I can help you understand iris analysis results, explain eye conditions, and guide you on next steps. What would you like to know?';
  }
  if(msg.includes('tamil')||msg.includes('à®¤à®®à®¿à®´à¯')) {
    setLang('ta');
    return 'à®¤à®®à®¿à®´à¯ à®®à¯Šà®´à®¿ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯. à®‰à®™à¯à®•à®³à¯ à®•à®£à¯ à®†à®°à¯‹à®•à¯à®•à®¿à®¯à®®à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®³à¯à®µà®¿à®•à®³à¯ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯.';
  }
  if(msg.includes('hindi')||msg.includes('à¤¹à¤¿à¤‚à¤¦à¥€')) {
    setLang('hi');
    return 'à¤¹à¤¿à¤‚à¤¦à¥€ à¤­à¤¾à¤·à¤¾ à¤šà¥à¤¨à¥€ à¤—à¤ˆà¥¤ à¤…à¤ªà¤¨à¥€ à¤†à¤à¤–à¥‹à¤‚ à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤•à¥‹à¤ˆ à¤­à¥€ à¤¸à¤µà¤¾à¤² à¤ªà¥‚à¤›à¥‡à¤‚à¥¤';
  }
  // Default
  const defaults=[
    `That\'s a great question about eye health. IrisScope analyzes iris sectors for colour and contour anomalies. For personalized medical advice, I always recommend consulting a qualified ophthalmologist who can examine your eyes directly. Is there a specific aspect of your analysis or eye health you'd like to understand better?`,
    `I understand your concern. While IrisScope provides useful insights as an early awareness tool, only a qualified eye specialist can provide a proper diagnosis. Would you like me to explain what any specific part of your iris analysis means?`,
    `Eye health is so important! I can explain iris analysis findings, common eye conditions, and when to seek care. For ${hasResult?`your recent result of ${topDis}`:'your analysis'}, would you like a more detailed breakdown?`
  ];
  return defaults[Math.floor(Math.random()*defaults.length)];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOICE / SPEECH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let recog=null;

function toggleVoiceInput() {
  if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)) {
    showToast('Speech recognition not supported in this browser','âš ï¸'); return;
  }
  if(STATE.voiceActive) { if(recog) recog.stop(); return; }
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recog=new SR();
  recog.continuous=false; recog.interimResults=true;
  recog.lang=STATE.lang==='ta'?'ta-IN':STATE.lang==='hi'?'hi-IN':'en-US';
  recog.onstart=()=>{
    STATE.voiceActive=true;
    document.getElementById('voice-sym-btn').classList.add('listening');
    document.getElementById('voice-status').style.display='flex';
  };
  recog.onresult=e=>{
    const txt=[...e.results].map(r=>r[0].transcript).join('');
    document.getElementById('voice-text').textContent=txt;
    // Simple keyword parsing
    const lo=txt.toLowerCase();
    if(lo.includes('pain')||lo.includes('à®µà®²à®¿')||lo.includes('à¤¦à¤°à¥à¤¦')) { document.getElementById('s-pain').value=2; updateSym('pain',2); }
    if(lo.includes('blur')||lo.includes('à®®à®™à¯à®•à®²')||lo.includes('à¤§à¥à¤‚à¤§')) { document.getElementById('s-blur').value=2; updateSym('blur',2); }
    if(lo.includes('red')||lo.includes('à®šà®¿à®µà®ªà¯')||lo.includes('à¤²à¤¾à¤²')) { document.getElementById('s-red').value=2; updateSym('red',2); }
    if(lo.includes('light')||lo.includes('à®’à®³à®¿')||lo.includes('à¤ªà¥à¤°à¤•à¤¾à¤¶')) { document.getElementById('s-light').value=2; updateSym('light',2); }
  };
  recog.onend=()=>{
    STATE.voiceActive=false;
    document.getElementById('voice-sym-btn').classList.remove('listening');
    document.getElementById('voice-status').style.display='none';
  };
  recog.start();
}

function toggleChatVoice() {
  STATE.chatVoiceActive=!STATE.chatVoiceActive;
  document.getElementById('chat-voice-btn').classList.toggle('listening',STATE.chatVoiceActive);
  if(!STATE.chatVoiceActive) { window.speechSynthesis&&speechSynthesis.cancel(); return; }
  // Also start STT for chat
  if(!('webkitSpeechRecognition' in window||'SpeechRecognition' in window)) { showToast('Speech not supported','âš ï¸'); return; }
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  const cr=new SR();
  cr.lang=STATE.lang==='ta'?'ta-IN':STATE.lang==='hi'?'hi-IN':'en-US';
  cr.onresult=e=>{
    document.getElementById('chat-input').value=e.results[0][0].transcript;
    sendChat();
  };
  cr.onend=()=>{ if(STATE.chatVoiceActive) cr.start(); };
  cr.start();
}

function speak(text) {
  if(!window.speechSynthesis) return;
  const cleaned=text.replace(/<[^>]*>/g,'');
  const u=new SpeechSynthesisUtterance(cleaned);
  u.lang=STATE.lang==='ta'?'ta-IN':STATE.lang==='hi'?'hi-IN':'en-US';
  u.rate=0.95; u.pitch=1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

function readResults() {
  if(!STATE.lastResults) { showToast('No results to read','âš ï¸'); return; }
  const r=STATE.lastResults.results[0];
  const msg=`Your iris analysis shows ${r.pct} percent likelihood for ${r.name}. ${r.desc} Affected sectors are ${r.sectors.map(s=>'sector '+s).join(', ')}. This is a decision-support indicator. Please consult an ophthalmologist.`;
  speak(msg);
  showToast('Reading results...','ğŸ”Š');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOSPITALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HOSPITALS_DATA=[
  {name:'Sankara Nethralaya',addr:'18 College Rd, Nungambakkam, Chennai',dist:'2.3 km',rating:5,specialty:'Cornea, Retina, Glaucoma'},
  {name:'Aravind Eye Hospital',addr:'72 Kuruvikaran Salai, Chennai',dist:'4.1 km',rating:5,specialty:'Full spectrum eye care'},
  {name:'LV Prasad Eye Institute',addr:'Chennai branch, Adyar',dist:'5.8 km',rating:5,specialty:'Retina, Low vision'},
  {name:'Dr. Mohan Eye Hospital',addr:'2B, Cathedral Rd, Gopalapuram',dist:'3.2 km',rating:4,specialty:'Cataract, LASIK'},
  {name:'Global Hospitals Eye Dept',addr:'439 Cheran Nagar, Perumbakkam',dist:'7.4 km',rating:4,specialty:'General ophthalmology'},
  {name:'AIIMS Ophthalmology Dept',addr:'Virtual via telemedicine',dist:'Online',rating:5,specialty:'Rare conditions, Research'},
];

function searchHospitals(query) {
  const loc=document.getElementById('location-input')?.value||'Chennai';
  const list=document.getElementById('hospital-list');
  if(!list) return;
  list.innerHTML=`<div class="loader"><div class="spin"></div> Searching near ${loc}...</div>`;
  setTimeout(()=>{
    list.innerHTML=HOSPITALS_DATA.map(h=>`
    <div class="hospital-card">
      <div class="hosp-icon">ğŸ¥</div>
      <div style="flex:1">
        <div class="hosp-name">${h.name}</div>
        <div class="hosp-addr">ğŸ“ ${h.addr}</div>
        <div style="font-size:.78rem;color:var(--c-muted);margin-top:3px">ğŸ”¬ ${h.specialty}</div>
        <div class="hosp-dist">ğŸ“ ${h.dist}</div>
        <div class="hosp-rating">${'â˜…'.repeat(h.rating)}${'â˜†'.repeat(5-h.rating)}</div>
      </div>
      <div>
        <button class="voice-btn" style="font-size:.78rem;padding:6px 10px" onclick="showToast('Opening maps...','ğŸ—ºï¸')">ğŸ—ºï¸ Map</button>
      </div>
    </div>`).join('');
  },800);
}

function getGPS() {
  if(!navigator.geolocation) { showToast('GPS not available','âš ï¸'); return; }
  document.getElementById('gps-status').textContent='ğŸ“¡ Getting your location...';
  navigator.geolocation.getCurrentPosition(pos=>{
    document.getElementById('gps-status').textContent=`ğŸ“ Location: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
    document.getElementById('location-input').value='Your current location';
    searchHospitals();
  },err=>{
    document.getElementById('gps-status').textContent='âš ï¸ Could not get location. Using default.';
    searchHospitals();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveToHistory(results) {
  if(!STATE.user) return;
  const entry={
    id: Date.now(),
    date: new Date().toLocaleString(),
    top: results[0].name,
    pct: results[0].pct,
    risk: results[0].pct>55?'High':results[0].pct>30?'Moderate':'Low',
    results,
    symptoms:{...STATE.symptoms},
  };
  STATE.history.unshift(entry);
  localStorage.setItem(`iris_history_${STATE.user.email}`, JSON.stringify(STATE.history));
  renderHistory();
}

function renderHistory() {
  const list=document.getElementById('history-list');
  document.getElementById('stat-total').textContent=STATE.history.length;
  if(STATE.history.length>0) {
    document.getElementById('stat-last').textContent=STATE.history[0].date.split(',')[0];
    const r=STATE.history[0].risk;
    document.getElementById('stat-risk').textContent=r;
    document.getElementById('stat-risk').style.color=r==='High'?'var(--c-red)':r==='Moderate'?'var(--c-gold)':'var(--c-teal)';
  }
  if(!list) return;
  if(STATE.history.length===0) {
    list.innerHTML='<div style="text-align:center;padding:40px;color:var(--c-muted);font-size:.9rem">No analyses saved yet. Run an iris analysis to see it here.</div>';
    return;
  }
  list.innerHTML=STATE.history.map(h=>`
  <div class="hist-card" onclick="showHistDetail(${h.id})">
    <div style="width:44px;height:44px;border-radius:8px;background:rgba(0,200,160,0.1);border:1px solid var(--c-border);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0">ğŸ‘ï¸</div>
    <div>
      <div class="hist-date">${h.date}</div>
      <div class="hist-result">${h.top}</div>
      <div class="hist-conf" style="color:${h.risk==='High'?'var(--c-red)':h.risk==='Moderate'?'var(--c-gold)':'var(--c-teal)'}">
        ${h.pct}% Â· ${h.risk} Risk
      </div>
    </div>
    <div class="hist-actions">
      <div class="icon-btn" onclick="event.stopPropagation();generateHistReport(${h.id})" title="Report">ğŸ“„</div>
      <div class="icon-btn" onclick="event.stopPropagation();deleteHistEntry(${h.id})" title="Delete">ğŸ—‘ï¸</div>
    </div>
  </div>`).join('');
}

function showHistDetail(id) {
  const h=STATE.history.find(e=>e.id===id); if(!h) return;
  showToast(`Viewing: ${h.date}`,'ğŸ“‹');
}

function deleteHistEntry(id) {
  STATE.history=STATE.history.filter(h=>h.id!==id);
  if(STATE.user) localStorage.setItem(`iris_history_${STATE.user.email}`,JSON.stringify(STATE.history));
  renderHistory();
  showToast('Entry deleted','ğŸ—‘ï¸');
}

function clearHistory() {
  if(!confirm('Clear all history?')) return;
  STATE.history=[];
  if(STATE.user) localStorage.removeItem(`iris_history_${STATE.user.email}`);
  renderHistory();
  showToast('History cleared','ğŸ—‘ï¸');
}

function generateHistReport(id) {
  const h=STATE.history.find(e=>e.id===id); if(!h) return;
  STATE.lastResults={results:h.results, symptoms:h.symptoms};
  showReport();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showReport() {
  if(!STATE.lastResults) { showToast('No analysis to report','âš ï¸'); return; }
  const r=STATE.lastResults.results;
  const s=STATE.symptoms;
  const now=new Date().toLocaleString();
  const user=STATE.user||{name:'User',email:'â€”'};
  document.getElementById('report-body').innerHTML=`
  <div class="report-section">
    <h4>Patient Information</h4>
    <div class="report-row"><span>Name</span><span>${user.name}</span></div>
    <div class="report-row"><span>Email</span><span>${user.email}</span></div>
    <div class="report-row"><span>Report Date</span><span>${now}</span></div>
    <div class="report-row"><span>Age</span><span>${document.getElementById('pt-age')?.value||'â€”'}</span></div>
  </div>
  <div class="report-section">
    <h4>Reported Symptoms</h4>
    <div class="report-row"><span>Eye Pain</span><span>${s.pain}/3</span></div>
    <div class="report-row"><span>Blurred Vision</span><span>${s.blur}/3</span></div>
    <div class="report-row"><span>Redness</span><span>${s.red}/3</span></div>
    <div class="report-row"><span>Light Sensitivity</span><span>${s.light}/3</span></div>
    <div class="report-row"><span>Discharge</span><span>${s.dis}/3</span></div>
    <div class="report-row"><span>Floaters</span><span>${s.float}/3</span></div>
  </div>
  <div class="report-section">
    <h4>AI Prediction Results</h4>
    ${r.slice(0,5).map((d,i)=>`<div class="report-row"><span>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4.','5.'][i]} ${d.name}</span><span style="color:${d.pct>55?'var(--c-red)':d.pct>30?'var(--c-gold)':'var(--c-teal)'};font-weight:700">${d.pct}%</span></div>`).join('')}
  </div>
  <div class="report-section">
    <h4>Disclaimer</h4>
    <p style="font-size:.82rem;color:var(--c-muted);line-height:1.6">IrisScope is an AI-powered decision-support and early awareness tool. It is NOT a medical diagnostic system. The predictions provided are indicative likelihood scores based on iris sector image analysis and self-reported symptoms. They do not constitute a clinical diagnosis. Always consult a qualified ophthalmologist or eye care professional for proper evaluation and treatment. The developers of IrisScope accept no medical liability for actions taken based on these results.</p>
  </div>`;
  document.getElementById('report-modal').classList.remove('hidden');
}

function closeReport() { document.getElementById('report-modal').classList.add('hidden'); }

function downloadReport() {
  if(!STATE.lastResults) return;
  const r=STATE.lastResults.results;
  const s=STATE.symptoms;
  const user=STATE.user||{name:'User',email:'â€”'};
  const txt=`
IRISSCOPE DIAGNOSTIC REPORT
${'='.repeat(50)}
Generated: ${new Date().toLocaleString()}
Patient: ${user.name} (${user.email})

SYMPTOMS REPORTED
Eye Pain          : ${s.pain}/3
Blurred Vision    : ${s.blur}/3
Redness           : ${s.red}/3
Light Sensitivity : ${s.light}/3
Discharge         : ${s.dis}/3
Floaters          : ${s.float}/3

AI PREDICTION RESULTS
${r.slice(0,5).map((d,i)=>`${i+1}. ${d.name} â€” ${d.pct}%\n   ${d.desc}`).join('\n')}

DISCLAIMER
IrisScope is a decision-support tool, not a medical diagnostic system.
Always consult a qualified ophthalmologist.
${'='.repeat(50)}`;
  const blob=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`irisscope_report_${Date.now()}.txt`;
  a.click();
  showToast('Report downloaded','ğŸ“¥');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer=null;
function showToast(msg, icon='â„¹ï¸') {
  const t=document.getElementById('toast');
  document.getElementById('toast-msg').textContent=msg;
  document.getElementById('toast-icon').textContent=icon;
  t.classList.add('show');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),3000);
}
</script>
</body>
</html>